<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>विद्यालय लेखा प्रणाली</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mukta:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Styling */
        :root {
            --primary-color: #005A9C;
            --secondary-color: #1E88E5;
            --background-color: #f4f7fc;
            --text-color: #333;
            --header-bg: #ffffff;
            --border-color: #ddd;
            --success-color: #4CAF50;
            --danger-color: #f44336;
            --edit-color: #ff9800;
            --light-blue-bg: #eef2f7;
        }

        body {
            font-family: 'Mukta', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        /* Login Styles */
        #login-container {
            width: 100%;
            max-width: 400px;
            padding: 40px;
            background-color: var(--header-bg);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 8px;
            text-align: center;
        }

        #login-container h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .login-form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .login-form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }
        #login-error {
            color: var(--danger-color);
            margin-top: 10px;
            min-height: 20px;
        }
        .login-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .login-btn:hover {
            background-color: var(--secondary-color);
        }

        #auth-toggle-link {
            margin-top: 15px;
            color: var(--primary-color);
            cursor: pointer;
            display: inline-block;
            text-decoration: underline;
        }

        #app-container {
            width: 100%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: var(--header-bg);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        
        .hidden { display: none; }
        
        #loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid var(--primary-color);
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        header {
            text-align: center;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
            position: relative;
        }

        header h1 { margin: 0; color: var(--primary-color); font-size: 2.2em; }
        header p { margin: 5px 0; font-size: 1.1em; }
        header h2 { margin: 10px 0 0; color: var(--secondary-color); font-weight: normal; }

        #logout-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        nav { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .nav-btn { background-color: #f0f0f0; border: 1px solid var(--border-color); padding: 10px 20px; border-radius: 5px; cursor: pointer; font-family: 'Mukta', sans-serif; font-size: 1em; transition: all 0.3s ease; }
        .nav-btn:hover { background-color: var(--secondary-color); color: white; }
        .nav-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .content-section { display: none; animation: fadeIn 0.5s; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        h3 { color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-top: 0; }
        form { display: flex; flex-direction: column; gap: 15px; }
        .form-row { display: flex; gap: 20px; }
        .form-group { flex: 1; display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="email"], input[type="password"], select { padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-family: 'Mukta', sans-serif; font-size: 1em; }
        input[type="number"] { text-align: right; }
        .form-buttons { display: flex; gap: 10px; align-items: center; }
        button { cursor: pointer; font-family: 'Mukta', sans-serif; font-size: 1em; }
        .submit-btn { background-color: var(--success-color); color: white; padding: 12px 20px; border: none; border-radius: 5px; }
        .submit-btn:hover { opacity: 0.9; }
        .cancel-btn { background-color: #6c757d; color: white; padding: 12px 20px; border: none; border-radius: 5px; }
        .print-btn { background-color: var(--primary-color); color: white; border: none; padding: 8px 15px; border-radius: 5px; }
        .edit-btn { background-color: var(--edit-color); color: white; border: none; padding: 5px 10px; border-radius: 4px; margin-left: 5px; }
        .delete-btn { background-color: var(--danger-color); color: white; border: none; padding: 5px 10px; border-radius: 4px; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        #ledger-table th, #trial-balance-table th, #voucher-entry-table th { background-color: var(--light-blue-bg); }
        #trial-balance-table tfoot td { font-weight: bold; background-color: var(--light-blue-bg); }
        td input[type="number"] { width: 100%; box-sizing: border-box; -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        td select { width: 100%; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        #add-voucher-row-btn { background-color: var(--primary-color); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; font-size: 1.2em; line-height: 1; }
        .voucher-totals { display: flex; justify-content: flex-end; gap: 30px; font-weight: bold; font-size: 1.1em; padding: 10px; background-color: #f9f9f9; border-top: 2px solid var(--primary-color); }
        #summary-cards { display: flex; gap: 20px; margin-bottom: 20px; }
        .card { flex: 1; background-color: #e7f3fe; padding: 20px; border-radius: 8px; border-left: 5px solid var(--secondary-color); }
        .card h4 { margin-top: 0; }
        .card p { font-size: 2em; font-weight: bold; margin: 0; color: var(--primary-color); }
        .report-header, .ledger-header { display: flex; justify-content: space-between; align-items: center; }
        
        @media print {
            body {
                display: block; /* Overrides flexbox for printing */
                min-height: auto;
                background-color: #fff;
            }
            .container, nav, header h2, .content-section:not(.active), form, .nav-btn, button, #login-container, #app-container, #logout-btn { 
                display: none !important; 
            }
            #print-area { 
                display: block !important; 
                font-family: 'Mukta', sans-serif; 
            }
            #print-area table { 
                font-size: 11pt; /* Increased font size for better readability */
                width: 100%; 
                border-collapse: collapse; 
            }
            #print-area th, #print-area td { 
                padding: 8px 5px; 
                border: 1px solid #333; 
            }
            #print-area .voucher-print-table tbody tr:not(.narration-row) td {
                border-top: none;
                border-bottom: none;
            }
            #print-area .voucher-print-table tbody tr:not(.narration-row):last-of-type td {
                border-bottom: 1px solid #333;
            }
            .print-header { 
                text-align: center; 
                margin-bottom: 20px; 
            }
            .print-header h1 { 
                font-size: 18pt; /* Increased font size */
                margin: 0; 
                color: #000; 
            }
            .print-header p, .print-header h2 { 
                font-size: 12pt; /* Increased font size */
                margin: 2px 0; 
                color: #000; 
                font-weight: normal; 
            }
            .print-voucher-info { 
                display: flex; 
                justify-content: space-between; 
                margin-bottom: 10px; 
                font-size: 12pt; /* Increased font size */
            }
            .print-footer { 
                margin-top: 40px; 
                display: flex; 
                justify-content: space-between; 
                font-size: 11pt; 
                page-break-inside: avoid;
            }
            .footer-box { 
                width: 200px; 
                text-align: center; 
            }
            .footer-box p { 
                margin: 40px 0 5px 0; 
                border-top: 1px solid #000; 
                padding-top: 5px; 
            }
            .narration-row td { 
                font-style: italic; 
            }
        }

        #print-area { display: none; }
    </style>
</head>
<body>

    <!-- Login Container -->
    <div id="login-container">
        <h2 id="auth-title">लेखा प्रणालीमा लगइन गर्नुहोस्</h2>
        <form id="login-form">
            <div class="login-form-group">
                <label for="email">प्रयोगकर्ता (Email)</label>
                <input type="email" id="email" placeholder="आफ्नो इमेल राख्नुहोस्" required>
            </div>
            <div class="login-form-group">
                <label for="password">पासवर्ड</label>
                <input type="password" id="password" placeholder="आफ्नो पासवर्ड राख्नुहोस्" required>
            </div>
            <div class="login-form-group hidden" id="confirm-password-group">
                <label for="confirm-password">पासवर्ड निश्चित गर्नुहोस्</label>
                <input type="password" id="confirm-password">
            </div>
            <div id="login-error"></div>
            <button type="submit" class="login-btn" id="auth-btn">लगइन गर्नुहोस्</button>
        </form>
        <div id="auth-toggle-link">खाता छैन? साइन अप गर्नुहोस्</div>
    </div>
    
    <!-- Loader -->
    <div id="loader" class="hidden"></div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <header>
            <h1>सूर्य ज्योति माध्यमिक विद्यालय मेहेलकुना</h1>
            <p>गुर्भाकोट नगरपालिका-८, सुर्खेत</p>
            <h2>लेखा प्रणाली</h2>
            <button id="logout-btn">लगआउट</button>
        </header>

        <nav>
            <button id="nav-dashboard" class="nav-btn active">ड्यासबोर्ड</button>
            <button id="nav-voucher" class="nav-btn">गोश्वार भौचर</button>
            <button id="nav-accounts" class="nav-btn">खाता व्यवस्थापन</button>
            <button id="nav-ledger" class="nav-btn">लेजर</button>
            <button id="nav-trial-balance" class="nav-btn">सन्तुलन परीक्षण</button>
        </nav>

        <main>
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="content-section active">
                <h3>ड्यासबोर्डमा स्वागत छ!</h3>
                <p>यहाँ तपाईंले प्रणालीको संक्षिप्त विवरण र हालसालैका गतिविधिहरू हेर्न सक्नुहुन्छ।</p>
                <div id="summary-cards">
                    <div class="card">
                        <h4>कुल खाताहरू</h4>
                        <p id="total-accounts-count">०</p>
                    </div>
                    <div class="card">
                        <h4>कुल भौचरहरू</h4>
                        <p id="total-vouchers-count">०</p>
                    </div>
                </div>
                <h4>पछिल्ला भौचरहरू</h4>
                <div class="table-container">
                    <table id="recent-vouchers-table">
                        <thead>
                            <tr>
                                <th>भौचर नं.</th>
                                <th>मिति</th>
                                <th>जम्मा रकम</th>
                                <th>कार्य</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Voucher Section -->
            <section id="voucher-section" class="content-section">
                <h3 id="voucher-form-title">नयाँ गोश्वार भौचर</h3>
                <form id="voucher-form">
                    <input type="hidden" id="editing-voucher-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="voucher-no">भौचर नं.</label>
                            <input type="text" id="voucher-no" required>
                        </div>
                        <div class="form-group">
                            <label for="voucher-date">मिति (YYYYMMDD)</label>
                            <input type="text" id="voucher-date" placeholder="जस्तै: 20810203" required>
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="voucher-narration">संक्षिप्त विवरण (Narration)</label>
                        <input type="text" id="voucher-narration" placeholder="जस्तै: तलब भुक्तानी सम्बन्धमा" required>
                    </div>
                    <div class="table-container">
                        <table id="voucher-entry-table">
                            <thead>
                                <tr>
                                    <th>विवरण (खाता)</th>
                                    <th>डेबिट (रु.)</th>
                                    <th>क्रेडिट (रु.)</th>
                                    <th><button type="button" id="add-voucher-row-btn">+</button></th>
                                </tr>
                            </thead>
                            <tbody id="voucher-entry-body">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                    <div class="voucher-totals">
                        <div>जम्मा डेबिट: <span id="total-debit">०/-</span></div>
                        <div>जम्मा क्रेडिट: <span id="total-credit">०/-</span></div>
                    </div>
                    <div class="form-buttons">
                        <button type="submit" id="save-voucher-btn" class="submit-btn">भौचर सुरक्षित गर्नुहोस्</button>
                        <button type="button" id="cancel-edit-btn" class="cancel-btn" style="display: none;">रद्द गर्नुहोस्</button>
                    </div>
                </form>
            </section>

            <!-- Accounts Section -->
            <section id="accounts-section" class="content-section">
                <h3>खाताका शीर्षकहरू व्यवस्थापन गर्नुहोस्</h3>
                <form id="add-account-form">
                    <div class="form-group">
                        <label for="account-name">नयाँ खाताको नाम</label>
                        <input type="text" id="account-name" placeholder="जस्तै: नगद खाता" required>
                    </div>
                    <button type="submit" class="submit-btn">खाता थप्नुहोस्</button>
                </form>
                <hr>
                <h4>विद्यमान खाताहरू</h4>
                <div class="table-container">
                    <table id="accounts-table">
                        <thead>
                            <tr>
                                <th>क्रम संख्या</th>
                                <th>खाताको नाम</th>
                                <th>कार्य</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Ledger Section -->
            <section id="ledger-section" class="content-section">
                <h3>खाताको लेजर हेर्नुहोस्</h3>
                <div class="form-group">
                    <label for="ledger-account-select">खाता छान्नुहोस्</label>
                    <select id="ledger-account-select">
                        <option value="">-- खाता छान्नुहोस् --</option>
                    </select>
                </div>
                <div id="ledger-report">
                    <div class="ledger-header">
                        <h4 id="ledger-account-title"></h4>
                        <button id="print-ledger-btn" class="print-btn" style="display: none;">प्रिन्ट गर्नुहोस्</button>
                    </div>
                    <div class="table-container">
                        <table id="ledger-table">
                            <thead>
                                <tr>
                                    <th>मिति</th>
                                    <th>विवरण</th>
                                    <th>भौ.नं.</th>
                                    <th>डेबिट (रु.)</th>
                                    <th>क्रेडिट (रु.)</th>
                                    <th>बाँकी (रु.)</th>
                                    <th>डे./क्रे.</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

             <!-- Trial Balance Section -->
            <section id="trial-balance-section" class="content-section">
                 <div class="report-header">
                    <h3>सन्तुलन परीक्षण</h3>
                    <button id="print-trial-balance-btn" class="print-btn">प्रिन्ट गर्नुहोस्</button>
                </div>
                <div class="table-container">
                    <table id="trial-balance-table">
                        <thead>
                            <tr>
                                <th>खाताको नाम</th>
                                <th>डेबिट (रु.)</th>
                                <th>क्रेडिट (रु.)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JS will populate this -->
                        </tbody>
                        <tfoot>
                            <!-- JS will populate this -->
                        </tfoot>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- This div is hidden and used only for printing -->
    <div id="print-area"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDZ1_bVyAVhExJ1N62hOGQqWp9ORcpRBTw",
            authDomain: "surya-account.firebaseapp.com",
            projectId: "surya-account",
            storageBucket: "surya-account.appspot.com",
            messagingSenderId: "19051227285",
            appId: "1:19051227285:web:aec46bde47b0759f48539c"
        };


        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State (populated from Firestore)
        let state = { accounts: [], vouchers: [] };
        let unsubscribeAccounts = null;
        let unsubscribeVouchers = null;
        let isSignUpMode = false;

        // --- DOM Elements ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loader = document.getElementById('loader');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const authTitle = document.getElementById('auth-title');
        const authBtn = document.getElementById('auth-btn');
        const confirmPasswordGroup = document.getElementById('confirm-password-group');
        const authToggleLink = document.getElementById('auth-toggle-link');
        
        const navButtons = document.querySelectorAll('.nav-btn');
        const contentSections = document.querySelectorAll('.content-section');
        const addAccountForm = document.getElementById('add-account-form');
        const accountNameInput = document.getElementById('account-name');
        const accountsTableBody = document.querySelector('#accounts-table tbody');
        const voucherForm = document.getElementById('voucher-form');
        const voucherFormTitle = document.getElementById('voucher-form-title');
        const voucherNoInput = document.getElementById('voucher-no');
        const voucherDateInput = document.getElementById('voucher-date');
        const voucherNarrationInput = document.getElementById('voucher-narration');
        const voucherEntryBody = document.getElementById('voucher-entry-body');
        const addVoucherRowBtn = document.getElementById('add-voucher-row-btn');
        const totalDebitSpan = document.getElementById('total-debit');
        const totalCreditSpan = document.getElementById('total-credit');
        const editingVoucherIdInput = document.getElementById('editing-voucher-id');
        const saveVoucherBtn = document.getElementById('save-voucher-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const ledgerAccountSelect = document.getElementById('ledger-account-select');
        const ledgerTableBody = document.querySelector('#ledger-table tbody');
        const ledgerAccountTitle = document.getElementById('ledger-account-title');
        const printLedgerBtn = document.getElementById('print-ledger-btn');
        const trialBalanceTableBody = document.querySelector('#trial-balance-table tbody');
        const trialBalanceTableFoot = document.querySelector('#trial-balance-table tfoot');
        const printTrialBalanceBtn = document.getElementById('print-trial-balance-btn');
        const printArea = document.getElementById('print-area');
        const totalAccountsCount = document.getElementById('total-accounts-count');
        const totalVouchersCount = document.getElementById('total-vouchers-count');
        const recentVouchersTableBody = document.querySelector('#recent-vouchers-table tbody');

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in.
                loginContainer.classList.add('hidden');
                loader.classList.remove('hidden');
                
                // Fetch data from Firestore
                setupFirestoreListeners();
                
                // A short delay to give a sense of loading, then show the app
                setTimeout(() => {
                    loader.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                }, 1000);

            } else {
                // User is signed out.
                appContainer.classList.add('hidden');
                loader.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                // Unsubscribe from Firestore listeners when logged out
                if (unsubscribeAccounts) unsubscribeAccounts();
                if (unsubscribeVouchers) unsubscribeVouchers();
            }
        });

        const toggleAuthMode = () => {
            isSignUpMode = !isSignUpMode;
            loginError.textContent = '';
            if (isSignUpMode) {
                authTitle.textContent = 'नयाँ खाता खोल्नुहोस्';
                authBtn.textContent = 'साइन अप गर्नुहोस्';
                confirmPasswordGroup.classList.remove('hidden');
                authToggleLink.textContent = 'पहिले नै खाता छ? लगइन गर्नुहोस्';
            } else {
                authTitle.textContent = 'लेखा प्रणालीमा लगइन गर्नुहोस्';
                authBtn.textContent = 'लगइन गर्नुहोस्';
                confirmPasswordGroup.classList.add('hidden');
                authToggleLink.textContent = 'खाता छैन? साइन अप गर्नुहोस्';
            }
        };
        authToggleLink.addEventListener('click', toggleAuthMode);


        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            loginError.textContent = '';

            if (isSignUpMode) {
                // Handle Sign Up
                const confirmPassword = loginForm['confirm-password'].value;
                if (password !== confirmPassword) {
                    loginError.textContent = 'पासवर्डहरू मेल खाएनन्।';
                    return;
                }
                createUserWithEmailAndPassword(auth, email, password)
                    .then(userCredential => {
                        // Signed up and signed in
                        console.log('User created:', userCredential.user);
                    })
                    .catch(error => {
                        console.error("Sign up failed:", error);
                        if (error.code === 'auth/weak-password') {
                            loginError.textContent = 'पासवर्ड कम्तिमा ६ अक्षरको हुनुपर्छ।';
                        } else if (error.code === 'auth/email-already-in-use') {
                            loginError.textContent = 'यो इमेल पहिले नै दर्ता भइसकेको छ।';
                        } else {
                            loginError.textContent = 'साइन अप गर्न असफल भयो।';
                        }
                    });

            } else {
                // Handle Login
                signInWithEmailAndPassword(auth, email, password)
                    .catch(error => {
                        console.error("Login failed:", error);
                        loginError.textContent = 'प्रयोगकर्ता वा पासवर्ड मिलेन।';
                    });
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch(error => console.error("Logout failed:", error));
        });

        // --- FIRESTORE REAL-TIME LISTENERS ---
        function setupFirestoreListeners() {
            // Detach previous listeners if they exist
            if (unsubscribeAccounts) unsubscribeAccounts();
            if (unsubscribeVouchers) unsubscribeVouchers();

            const accountsCol = collection(db, 'accounts');
            unsubscribeAccounts = onSnapshot(accountsCol, (snapshot) => {
                state.accounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.accounts.sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically
                renderAccounts();
                renderLedgerSelect();
                renderDashboard();
            });

            const vouchersCol = query(collection(db, 'vouchers'), orderBy("voucherNo", "desc"));
            unsubscribeVouchers = onSnapshot(vouchersCol, (snapshot) => {
                state.vouchers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDashboard();
                 // Re-render ledger or trial balance if they are active
                if(document.getElementById('ledger-section').classList.contains('active')) renderLedger();
                if(document.getElementById('trial-balance-section').classList.contains('active')) renderTrialBalance();
            });
        }


        // --- Helper Functions (No changes here) ---
        const toDevanagari = (numStr) => String(numStr).replace(/[0-9]/g, d => '०१२३४५६७८९'[d]);
        const formatNepaliCurrency = (num) => { if (isNaN(num)) return '०'; const [integerPart, decimalPart] = String(num).split('.'); const lastThree = integerPart.slice(-3); const otherNumbers = integerPart.slice(0, -3); const formattedInteger = otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + (otherNumbers ? ',' : '') + lastThree; return decimalPart ? `${formattedInteger}.${decimalPart}` : formattedInteger; };
        const formatVoucherAmount = (num) => { if (num === null || num === undefined || isNaN(num) || num === 0) return '—'; const fixedNum = Number(num).toFixed(2); const [integerPart, decimalPart] = fixedNum.split('.'); const nepaliInteger = toDevanagari(formatNepaliCurrency(integerPart)); if (parseInt(decimalPart) === 0) return `${nepaliInteger}/-`; return `${nepaliInteger}/${toDevanagari(decimalPart)}`; };
        const formatDateInput = (e) => { let value = e.target.value.replace(/[^0-9]/g, ''); if (value.length >= 8) { value = value.slice(0, 8); const year = value.substring(0, 4); const month = value.substring(4, 6); const day = value.substring(6, 8); e.target.dataset.rawValue = `${year}-${month}-${day}`; e.target.value = `${toDevanagari(year)}-${toDevanagari(month)}-${toDevanagari(day)}`; } else { e.target.dataset.rawValue = ''; } };
        const formatNepaliDate = (dateString) => { if (!dateString) return ''; const [year, month, day] = dateString.split('-'); return `${toDevanagari(year)}/${toDevanagari(month)}/${toDevanagari(day)}`; };
        const handleVoucherNoInput = (e) => { const englishValue = e.target.value.replace(/[^0-9]/g, ''); e.target.dataset.rawValue = englishValue; e.target.value = toDevanagari(englishValue); };

        
        // --- RENDER FUNCTIONS ---
        const renderDashboard = () => {
            totalAccountsCount.textContent = toDevanagari(state.accounts.length);
            totalVouchersCount.textContent = toDevanagari(state.vouchers.length);
            recentVouchersTableBody.innerHTML = '';
            const recentVouchers = state.vouchers.slice(0, 5); // Already sorted by voucherNo desc
            if (recentVouchers.length === 0) {
                recentVouchersTableBody.innerHTML = '<tr><td colspan="4" class="text-center">कुनै भौचर भेटिएन।</td></tr>';
                return;
            }
            recentVouchers.forEach(voucher => {
                const total = voucher.entries.reduce((sum, entry) => sum + (entry.debit || 0), 0);
                recentVouchersTableBody.innerHTML += `<tr><td>${toDevanagari(voucher.voucherNo)}</td><td>${formatNepaliDate(voucher.date)}</td><td class="text-right">${formatVoucherAmount(total)}</td><td><button class="print-voucher-btn" data-voucher-id="${voucher.id}">प्रिन्ट</button><button class="edit-btn" data-voucher-id="${voucher.id}">एडिट</button></td></tr>`;
            });
        };

        const renderAccounts = () => {
            accountsTableBody.innerHTML = '';
            if (state.accounts.length === 0) {
                accountsTableBody.innerHTML = '<tr><td colspan="3" class="text-center">कुनै खाता थपिएको छैन।</td></tr>';
                return;
            }
            state.accounts.forEach((account, index) => {
                accountsTableBody.innerHTML += `<tr><td>${toDevanagari(index + 1)}</td><td>${account.name}</td><td><button class="delete-btn" data-id="${account.id}">हटाउनुहोस्</button></td></tr>`;
            });
        };
        
        const addVoucherRow = (entry = {}) => {
            const row = document.createElement('tr');
            const accountOptions = state.accounts.map(acc => `<option value="${acc.id}" ${entry.accountId === acc.id ? 'selected' : ''}>${acc.name}</option>`).join('');
            row.innerHTML = `<td><select class="voucher-account-select" required><option value="">-- खाता छान्नुहोस् --</option>${accountOptions}</select></td><td><input type="number" class="voucher-debit" value="${entry.debit || ''}" placeholder="०.००" step="0.01"></td><td><input type="number" class="voucher-credit" value="${entry.credit || ''}" placeholder="०.००" step="0.01"></td><td><button type="button" class="delete-row-btn">-</button></td>`;
            voucherEntryBody.appendChild(row);
        };

        const renderVoucherRows = (count = 2) => {
            voucherEntryBody.innerHTML = '';
            for (let i = 0; i < count; i++) { addVoucherRow(); }
            updateVoucherTotals();
        };

        const renderLedgerSelect = () => {
            const currentVal = ledgerAccountSelect.value;
            ledgerAccountSelect.innerHTML = ['<option value="">-- खाता छान्नुहोस् --</option>', ...state.accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`)].join('');
            ledgerAccountSelect.value = currentVal;
        };
        
        const updateVoucherTotals = () => {
            let totalDebit = 0, totalCredit = 0;
            document.querySelectorAll('#voucher-entry-body tr').forEach(row => {
                totalDebit += parseFloat(row.querySelector('.voucher-debit').value) || 0;
                totalCredit += parseFloat(row.querySelector('.voucher-credit').value) || 0;
            });
            totalDebitSpan.textContent = formatVoucherAmount(totalDebit);
            totalCreditSpan.textContent = formatVoucherAmount(totalCredit);
        };
        
        const renderLedger = () => {
            const accountId = ledgerAccountSelect.value;
            ledgerTableBody.innerHTML = '';
            printLedgerBtn.style.display = 'none';
            if (!accountId) {
                ledgerAccountTitle.textContent = '';
                return;
            }
            const account = state.accounts.find(a => a.id === accountId);
            if (!account) return;
            ledgerAccountTitle.textContent = `${account.name} को लेजर`;
            printLedgerBtn.style.display = 'inline-block';
            
            const relevantEntries = [];
            state.vouchers.forEach(voucher => {
                const mainEntry = voucher.entries.find(e => e.accountId === accountId);

                // If the account is not in this voucher, skip it
                if (!mainEntry) {
                    return;
                }

                const isDebitEntry = (mainEntry.debit || 0) > 0;

                // Find all accounts on the OPPOSITE side of the transaction
                const opposingAccountNames = voucher.entries
                    .filter(e => {
                        // If our main entry is a debit, we want all credit entries.
                        // If our main entry is a credit, we want all debit entries.
                        return isDebitEntry ? (e.credit || 0) > 0 : (e.debit || 0) > 0;
                    })
                    .map(e => {
                        const acc = state.accounts.find(a => a.id === e.accountId);
                        return acc ? acc.name : null;
                    })
                    .filter(name => name) // Remove nulls if an account was deleted
                    .join(', ');

                relevantEntries.push({
                    ...mainEntry,
                    date: voucher.date,
                    voucherNo: voucher.voucherNo,
                    description: opposingAccountNames || voucher.narration // Fallback to narration
                });
            });

            if (relevantEntries.length === 0) {
                ledgerTableBody.innerHTML = '<tr><td colspan="7" class="text-center">यस खातामा कुनै कारोबार छैन।</td></tr>';
                return;
            }

            // Sort entries by date, then by voucher number
            relevantEntries.sort((a, b) => new Date(a.date) - new Date(b.date) || a.voucherNo - b.voucherNo);
            
            let balance = 0;
            let tableHTML = '';
            relevantEntries.forEach(entry => {
                balance += (entry.debit || 0) - (entry.credit || 0);
                tableHTML += `<tr>
                    <td>${formatNepaliDate(entry.date)}</td>
                    <td>${entry.description}</td>
                    <td class="text-center">${toDevanagari(entry.voucherNo)}</td>
                    <td class="text-right">${formatVoucherAmount(entry.debit)}</td>
                    <td class="text-right">${formatVoucherAmount(entry.credit)}</td>
                    <td class="text-right">${formatVoucherAmount(Math.abs(balance))}</td>
                    <td class="text-center">${balance >= 0 ? 'डे.' : 'क्रे.'}</td>
                </tr>`;
            });
            ledgerTableBody.innerHTML = tableHTML;
        };

        const renderTrialBalance = () => {
            trialBalanceTableBody.innerHTML = '';
            trialBalanceTableFoot.innerHTML = '';
            let totalDebit = 0, totalCredit = 0;
            state.accounts.forEach(account => {
                let balance = 0;
                state.vouchers.forEach(voucher => {
                    voucher.entries.forEach(entry => {
                        if (entry.accountId === account.id) balance += (entry.debit || 0) - (entry.credit || 0);
                    });
                });
                if (balance !== 0) {
                    const isDebit = balance > 0;
                    trialBalanceTableBody.innerHTML += `<tr><td>${account.name}</td><td class="text-right">${isDebit ? formatVoucherAmount(balance) : '—'}</td><td class="text-right">${!isDebit ? formatVoucherAmount(Math.abs(balance)) : '—'}</td></tr>`;
                    if (isDebit) totalDebit += balance;
                    else totalCredit += Math.abs(balance);
                }
            });
            trialBalanceTableFoot.innerHTML = `<tr><td><b>जम्मा</b></td><td class="text-right"><b>${formatVoucherAmount(totalDebit)}</b></td><td class="text-right"><b>${formatVoucherAmount(totalCredit)}</b></td></tr>`;
            if (totalDebit.toFixed(2) !== totalCredit.toFixed(2)) {
                trialBalanceTableFoot.querySelector('tr').style.cssText = 'background-color: var(--danger-color); color: white;';
            }
        };
        
        // --- VOUCHER EDITING LOGIC ---
        const startEditVoucher = (voucherId) => {
            const voucher = state.vouchers.find(v => v.id === voucherId);
            if (!voucher) return;
            resetVoucherForm();
            editingVoucherIdInput.value = voucher.id;
            voucherFormTitle.textContent = `भौचर नं. ${toDevanagari(voucher.voucherNo)} सम्पादन गर्दै`;
            voucherNoInput.value = toDevanagari(voucher.voucherNo);
            voucherNoInput.dataset.rawValue = voucher.voucherNo;
            const [year, month, day] = voucher.date.split('-');
            voucherDateInput.value = `${toDevanagari(year)}-${toDevanagari(month)}-${toDevanagari(day)}`;
            voucherDateInput.dataset.rawValue = voucher.date;
            voucherNarrationInput.value = voucher.narration;
            voucherEntryBody.innerHTML = '';
            voucher.entries.forEach(entry => { addVoucherRow(entry); });
            updateVoucherTotals();
            saveVoucherBtn.textContent = 'अपडेट गर्नुहोस्';
            cancelEditBtn.style.display = 'inline-block';
            document.getElementById('nav-voucher').click();
        };
        const resetVoucherForm = () => {
            voucherForm.reset();
            editingVoucherIdInput.value = '';
            voucherNoInput.dataset.rawValue = '';
            voucherDateInput.dataset.rawValue = '';
            voucherFormTitle.textContent = 'नयाँ गोश्वार भौचर';
            saveVoucherBtn.textContent = 'भौचर सुरक्षित गर्नुहोस्';
            cancelEditBtn.style.display = 'none';
            renderVoucherRows();
        };

        // --- EVENT HANDLERS ---
        const handleNavClick = (e) => {
            if (!e.target.classList.contains('nav-btn')) return;
            navButtons.forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            const targetSectionId = e.target.id.replace('nav-', '') + '-section';
            contentSections.forEach(sec => sec.classList.remove('active'));
            document.getElementById(targetSectionId).classList.add('active');
            if (targetSectionId === 'dashboard-section') renderDashboard();
            if (targetSectionId === 'trial-balance-section') renderTrialBalance();
            if (e.target.id === 'nav-voucher' && !editingVoucherIdInput.value) {
                resetVoucherForm();
            }
        };

        // --- ASYNC EVENT HANDLERS (for Firestore operations) ---
        addAccountForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = accountNameInput.value.trim();
            if (name && !state.accounts.some(a => a.name === name)) {
                try {
                    await addDoc(collection(db, 'accounts'), { name });
                    accountNameInput.value = '';
                } catch (error) {
                    console.error("Error adding account: ", error);
                    alert('खाता थप्न असफल भयो।');
                }
            } else {
                alert('खाताको नाम खाली वा पहिले नै प्रयोग भइसकेको हुन सक्दैन।');
            }
        });

        accountsTableBody.addEventListener('click', async (e) => {
            if (!e.target.classList.contains('delete-btn')) return;
            const id = e.target.dataset.id;
            if (state.vouchers.some(v => v.entries.some(en => en.accountId === id))) {
                alert('यो खाता भौचरमा प्रयोग भइसकेकोले हटाउन मिल्दैन।');
                return;
            }
            if (confirm('के तपाईं यो खाता साँच्चै हटाउन चाहनुहुन्छ?')) {
                try {
                    await deleteDoc(doc(db, 'accounts', id));
                } catch (error) {
                    console.error("Error deleting account: ", error);
                    alert('खाता हटाउन असफल भयो।');
                }
            }
        });

        voucherForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const editingId = editingVoucherIdInput.value;
            let totalDebit = 0, totalCredit = 0;
            const entries = [];
            const voucherNo = parseInt(voucherNoInput.dataset.rawValue);
            const date = voucherDateInput.dataset.rawValue;
            const narration = voucherNarrationInput.value.trim();

            if (isNaN(voucherNo) || !date || !narration) { alert('कृपया सही भौचर नं., मिति, र संक्षिप्त विवरण भर्नुहोस्।'); return; }
            if (!editingId && state.vouchers.some(v => v.voucherNo === voucherNo)) { alert('यो भौचर नं. पहिले नै प्रयोग भइसकेको छ।'); return; }

            document.querySelectorAll('#voucher-entry-body tr').forEach(row => {
                const accountId = row.querySelector('.voucher-account-select').value;
                const debit = parseFloat(row.querySelector('.voucher-debit').value) || 0;
                const credit = parseFloat(row.querySelector('.voucher-credit').value) || 0;
                if (accountId && (debit > 0 || credit > 0)) {
                    entries.push({ accountId, debit, credit });
                    totalDebit += debit;
                    totalCredit += credit;
                }
            });

            if (entries.length < 2) { alert('भौचरमा कम्तिमा दुईवटा कारोबार हुनुपर्छ।'); return; }
            if (totalDebit.toFixed(2) !== totalCredit.toFixed(2) || totalDebit === 0) { alert('डेबिट र क्रेडिट रकम बराबर हुनुपर्छ र शून्य हुनुहुँदैन।'); return; }
            
            const voucherData = { voucherNo, date, narration, entries };

            try {
                if (editingId) {
                    await setDoc(doc(db, "vouchers", editingId), voucherData);
                    alert('भौचर सफलतापूर्वक अपडेट भयो!');
                } else {
                    await addDoc(collection(db, "vouchers"), voucherData);
                    alert('भौचर सफलतापूर्वक सुरक्षित भयो!');
                }
                resetVoucherForm();
                document.getElementById('nav-dashboard').click();
            } catch (error) {
                console.error("Error saving voucher: ", error);
                alert("भौचर सुरक्षित गर्न असफल भयो।");
            }
        });

        const handleDashboardClick = (e) => {
            if (e.target.classList.contains('print-voucher-btn')) {
                printVoucher(e.target.dataset.voucherId);
            }
            if (e.target.classList.contains('edit-btn')) {
                startEditVoucher(e.target.dataset.voucherId);
            }
        };

        // #### PRINT VOUCHER FUNCTION REVISED ####
        const printVoucher = (voucherId) => {
            const voucher = state.vouchers.find(v => v.id === voucherId);
            if (!voucher) return;
            
            let entriesHTML = '', total = 0;
            voucher.entries.forEach(entry => {
                const account = state.accounts.find(a => a.id === entry.accountId);
                const isDebit = entry.debit > 0;
                total += entry.debit || 0;
                entriesHTML += `
                    <tr>
                        <td class="text-center">${isDebit ? 'डे.' : 'क्रे.'}</td>
                        <td>${account ? account.name : 'N/A'}</td>
                        <td></td>
                        <td></td>
                        <td class="text-right">${isDebit ? formatVoucherAmount(entry.debit) : '—'}</td>
                        <td class="text-right">${!isDebit ? formatVoucherAmount(entry.credit) : '—'}</td>
                    </tr>
                `;
            });
            
            const voucherHTML = `
                <div class="print-header">
                    <h1>सूर्य ज्योति माध्यमिक विद्यालय मेहेलकुना</h1>
                    <p>गुर्भाकोट नगरपालिका-८, सुर्खेत</p>
                    <h2>गोश्वार भौचर</h2>
                </div>
                <div class="print-voucher-info">
                    <span><b>गो. भौचर नं.:</b> ${toDevanagari(voucher.voucherNo)}</span>
                    <span><b>मिति:</b> ${formatNepaliDate(voucher.date)}</span>
                </div>
                <table class="voucher-print-table" border="1">
                    <thead><tr><th style="width:5%">संकेत</th><th>विवरण</th><th style="width:8%">खाता</th><th style="width:8%">हिसाब नं.</th><th style="width:15%">डेबिट</th><th style="width:15%">क्रेडिट</th></tr></thead>
                    <tbody>${entriesHTML}<tr class="narration-row"><td colspan="6">(${voucher.narration})</td></tr></tbody>
                    <tfoot><tr><td colspan="4" class="text-right"><b>जम्मा</b></td><td class="text-right"><b>${formatVoucherAmount(total)}</b></td><td class="text-right"><b>${formatVoucherAmount(total)}</b></td></tr></tfoot>
                </table>
                <div class="print-footer">
                    <div class="footer-box"><p>तयार गर्ने</p><span>दर्जा: लेखापाल</span></div>
                    <div class="footer-box"><p>सदर गर्ने</p><span>दर्जा: प्र.अ.</span></div>
                </div>`;
            printArea.innerHTML = voucherHTML;
            window.print();
        };

        // --- PRINT FUNCTIONS (Other) ---
        const printLedger = () => {
            const accountId = ledgerAccountSelect.value;
            if (!accountId) return;
            const account = state.accounts.find(a => a.id === accountId);
            if (!account) return;
            const tableContent = document.getElementById('ledger-table').outerHTML;
            const headerHTML = `<div class="print-header"><h1>सूर्य ज्योति माध्यमिक विद्यालय मेहेलकुना</h1><p>गुर्भाकोट नगरपालिका-८, सुर्खेत</p><h2>${account.name} को लेजर</h2></div>`;
            printArea.innerHTML = headerHTML + tableContent;
            window.print();
        };
        const printTrialBalance = () => {
            const tableContent = document.getElementById('trial-balance-table').outerHTML;
            const headerHTML = `<div class="print-header"><h1>सूर्य ज्योति माध्यमिक विद्यालय मेहेलकुना</h1><p>गुर्भाकोट नगरपालिका-८, सुर्खेत</p><h2>सन्तुलन परीक्षण</h2></div>`;
            printArea.innerHTML = headerHTML + tableContent;
            window.print();
        };

        // --- Initial Event Listeners ---
        document.querySelector('nav').addEventListener('click', handleNavClick);
        cancelEditBtn.addEventListener('click', resetVoucherForm);
        voucherNoInput.addEventListener('input', handleVoucherNoInput);
        voucherDateInput.addEventListener('blur', formatDateInput);
        addVoucherRowBtn.addEventListener('click', () => addVoucherRow());
        voucherEntryBody.addEventListener('input', updateVoucherTotals);
        voucherEntryBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-row-btn')) {
                if (voucherEntryBody.rows.length > 2) e.target.closest('tr').remove();
                else alert('भौचरमा कम्तिमा दुई पङ्क्ति हुनुपर्छ।');
                updateVoucherTotals();
            }
        });
        ledgerAccountSelect.addEventListener('change', renderLedger);
        printLedgerBtn.addEventListener('click', printLedger);
        printTrialBalanceBtn.addEventListener('click', printTrialBalance);
        recentVouchersTableBody.addEventListener('click', handleDashboardClick);
    </script>
</body>
</html>








