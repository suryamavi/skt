<!DOCTYPE html>
<html lang="ne">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>विद्यालय लेखा प्रणाली</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mukta:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Styling */
        :root {
            --primary-color: #005A9C;
            --secondary-color: #1E88E5;
            --background-color: #f4f7fc;
            --text-color: #333;
            --header-bg: #ffffff;
            --border-color: #ddd;
            --success-color: #4CAF50;
            --danger-color: #f44336;
            --edit-color: #ff9800;
            --light-blue-bg: #eef2f7;
        }

        body {
            font-family: 'Mukta', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
        }
        
        #app-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2000; font-size: 1.2em;
        }

        .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-box h2 {
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .login-box .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .login-box .submit-btn {
            width: 100%;
            padding: 12px;
        }

        .login-box a {
            color: var(--secondary-color);
            text-decoration: none;
            cursor: pointer;
        }

        .login-box a:hover {
            text-decoration: underline;
        }

        .hidden {
            display: none !important;
        }

        .container {
            max-width: 1300px;
            margin: 20px auto;
            padding: 20px;
            background-color: var(--header-bg);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        header {
            text-align: center;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left, .header-right {
            flex-shrink: 0;
            width: 200px; /* Adjust as needed */
        }
        .header-left { text-align: left; }
        .header-right { text-align: right; }
        .header-center { flex-grow: 1; }


        header h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 2.2em;
        }

        header p {
            margin: 5px 0;
            font-size: 1.1em;
        }

        header h2 {
            margin: 10px 0 0;
            color: var(--secondary-color);
            font-weight: normal;
        }
        
        #active-fy-display {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--success-color);
            background-color: #e8f5e9;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
        }
        
        #logout-btn {
            background-color: var(--danger-color); color: white;
            border: none; padding: 8px 15px; border-radius: 5px;
            cursor: pointer; font-family: 'Mukta', sans-serif; font-size: 1em;
        }

        nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-btn {
            background-color: #f0f0f0;
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Mukta', sans-serif;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        .nav-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .content-section {
            display: none;
            animation: fadeIn 0.5s;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h3, h4 {
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            margin-top: 0;
        }

        /* Forms & Buttons */
        form { display: flex; flex-direction: column; gap: 15px; }
        .form-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .form-group { flex: 1; display: flex; flex-direction: column; min-width: 200px; }
        label { margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="password"], input[type="email"], select, input[type="date"] {
            padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;
            font-family: 'Mukta', sans-serif; font-size: 1em; width: 100%; box-sizing: border-box;
        }
        input[type="number"] { text-align: right; }
        .form-buttons { display: flex; gap: 10px; align-items: center; }
        button { cursor: pointer; font-family: 'Mukta', sans-serif; font-size: 1em; }
        .submit-btn { background-color: var(--success-color); color: white; padding: 12px 20px; border: none; border-radius: 5px; }
        .submit-btn:hover { opacity: 0.9; }
        .cancel-btn { background-color: #6c757d; color: white; padding: 12px 20px; border: none; border-radius: 5px; }
        .print-btn { background-color: var(--primary-color); color: white; border: none; padding: 8px 15px; border-radius: 5px; }
        .edit-btn, .action-btn-edit { background-color: var(--edit-color); color: white; border: none; padding: 5px 10px; border-radius: 4px; margin: 0 2px; }
        .delete-btn, .action-btn-delete { background-color: var(--danger-color); color: white; border: none; padding: 5px 10px; border-radius: 4px; margin: 0 2px; }
        .action-btn-activate { background-color: var(--success-color); color: white; border: none; padding: 5px 10px; border-radius: 4px; margin: 0 2px; }

        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { border: 1px solid var(--border-color); padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        #accounts-table th, #ledger-table th, #trial-balance-table th, #voucher-entry-table th, #assets-table th { background-color: var(--light-blue-bg); }
        #trial-balance-table tfoot td, .report-table tfoot td, #assets-table tfoot td { font-weight: bold; background-color: var(--light-blue-bg); }
        td input[type="number"] { width: 100%; box-sizing: border-box; -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        td select { width: 100%; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        #add-voucher-row-btn { background-color: var(--primary-color); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; font-size: 1.2em; line-height: 1; }
        .voucher-totals { display: flex; justify-content: flex-end; gap: 30px; font-weight: bold; font-size: 1.1em; padding: 10px; background-color: #f9f9f9; border-top: 2px solid var(--primary-color); }
        .card { flex: 1; background-color: #e7f3fe; padding: 20px; border-radius: 8px; border-left: 5px solid var(--secondary-color); min-width: 200px; }
        .card h4 { margin-top: 0; }
        .card p { font-size: 2em; font-weight: bold; margin: 0; color: var(--primary-color); }
        
        /* Reports */
        .report-header, .ledger-header { display: flex; justify-content: space-between; align-items: center; }
        #income-expense-statement { display: flex; gap: 20px; }
        #income-expense-statement > div { flex: 1; }
        #income-expense-statement table { margin-top: 5px; }
        #income-expense-statement th { background-color: var(--light-blue-bg); }
        #income-expense-statement .sub-header { font-weight: bold; background-color: #f0f0f0; }
        .net-balance-row { font-weight: bold; font-size: 1.2em; background-color: #e0e0e0; }

        /* Settings Page */
        .setting-box {
            background-color: var(--light-blue-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        #fy-management-table td, #fy-management-table th { vertical-align: middle; }

        /* Reconciliation */
        .recon-container { display: flex; gap: 20px; }
        .recon-container > div { flex: 1; }
        .recon-table th { font-size: 0.9em; padding: 6px; }
        .recon-table td { font-size: 0.85em; padding: 5px; }
        .recon-table input[type="checkbox"] { margin-right: 5px; }
        .recon-totals { font-weight: bold; margin-top: 10px; }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: flex; align-items: center;
            justify-content: center; z-index: 1001; opacity: 0;
            transition: opacity 0.3s ease; pointer-events: none;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-box {
            background: white; padding: 20px 30px; border-radius: 8px;
            transform: scale(0.9); transition: transform 0.3s ease;
            max-width: 90%; width: 500px;
        }
        .modal-overlay.visible .modal-box { transform: scale(1); }
        .modal-box.success { border-top: 5px solid var(--success-color); text-align: center; }
        .modal-box.error { border-top: 5px solid var(--danger-color); text-align: center; }
        .modal-box h3 { margin-top: 0; }
        .modal-box div { display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px; }
        .modal-box button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .modal-box .submit-btn { background-color: var(--primary-color); }

        /* Print Styles */
        @media print {
            @page { size: A4; margin: 0.75in; }
            body { background-color: #fff; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .container, nav, .header-right, .header-left, header h2, .content-section:not(.active), form, .nav-btn, button, .form-buttons { display: none !important; }
            #print-area { display: block !important; font-family: 'Mukta', sans-serif; }
            #print-area table { font-size: 10pt; width: 100%; border-collapse: collapse; }
            #print-area th, #print-area td { padding: 6px 4px; border: 1px solid #333; }
            .print-header { text-align: center; margin-bottom: 20px; page-break-after: avoid; }
            .print-header h1 { font-size: 18pt; margin: 0; color: #000; }
            .print-header p { font-size: 12pt; margin: 2px 0; color: #000; }
            .print-header h2 { font-size: 14pt; margin: 5px 0; color: #000; font-weight: bold; }
            #print-area h1, #print-area h2, #print-area h3, #print-area h4 { color: #000; }
            /* T-Format print */
            #print-area #income-expense-statement { display: flex; gap: 20px; }
            #print-area #income-expense-statement > div { flex: 1; }
        }

        #print-area { display: none; }
    </style>
</head>

<body>
    <div id="app-loader">
        <div class="spinner"></div>
        <p id="loader-message">प्रणाली लोड हुँदैछ, कृपया पर्खनुहोस्...</p>
    </div>

    <div id="login-container" class="hidden">
        <div class="login-box">
            <div id="login-view">
                <h2>लगइन गर्नुहोस्</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">इमेल</label>
                        <input type="email" id="login-email" placeholder="आफ्नो इमेल राख्नुहोस्" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">पासवर्ड</label>
                        <input type="password" id="login-password" placeholder="आफ्नो पासवर्ड राख्नुहोस्" required>
                    </div>
                    <button type="submit" class="submit-btn">लगइन</button>
                </form>
                <p style="margin-top: 15px;">खाता छैन? <a id="show-signup">साइन अप गर्नुहोस्</a></p>
            </div>
            <div id="signup-view" class="hidden">
                <h2>नयाँ खाता खोल्नुहोस्</h2>
                <form id="signup-form">
                    <div class="form-group">
                        <label for="signup-email">इमेल</label>
                        <input type="email" id="signup-email" placeholder="आफ्नो इमेल राख्नुहोस्" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password">पासवर्ड</label>
                        <input type="password" id="signup-password" placeholder="नयाँ पासवर्ड बनाउनुहोस्" required>
                    </div>
                    <button type="submit" class="submit-btn">साइन अप</button>
                </form>
                <p style="margin-top: 15px;">पहिले नै खाता छ? <a id="show-login">लगइन गर्नुहोस्</a></p>
            </div>
        </div>
    </div>

    <div class="container hidden">
        <header>
            <div class="header-left">
                 <span id="active-fy-display"></span>
            </div>
            <div class="header-center">
                <h1>सूर्य ज्योति माध्यमिक विद्यालय मेहेलकुना</h1>
                <p>गुर्भाकोट नगरपालिका-८, सुर्खेत</p>
                <h2>लेखा प्रणाली</h2>
            </div>
            <div class="header-right">
                <button id="logout-btn">लगआउट</button>
            </div>
        </header>

        <nav>
            <button id="nav-dashboard" class="nav-btn active">ड्यासबोर्ड</button>
            <button id="nav-voucher-list" class="nav-btn">भौचर सूची</button>
            <button id="nav-voucher" class="nav-btn">गोश्वार भौचर</button>
            <button id="nav-accounts" class="nav-btn">खाता व्यवस्थापन</button>
            <button id="nav-assets" class="nav-btn">स्थिर सम्पत्ति</button>
            <button id="nav-ledger" class="nav-btn">लेजर</button>
            <button id="nav-trial-balance" class="nav-btn">सन्तुलन परीक्षण</button>
            <button id="nav-reconciliation" class="nav-btn">बैंक मिलान</button>
            <button id="nav-reports" class="nav-btn">आ.ख. रिपोर्ट</button>
            <button id="nav-settings" class="nav-btn">सेटिङ्ग</button>
        </nav>

        <main>
            <!-- All sections are here... -->
            <section id="dashboard-section" class="content-section active">
                <h3>ड्यासबोर्डमा स्वागत छ!</h3>
                <div id="summary-cards" style="display:flex; gap: 20px; margin-bottom: 20px;">
                    <div class="card"><h4>कुल खाताहरू</h4><p id="total-accounts-count">०</p></div>
                    <div class="card"><h4>कुल भौचरहरू</h4><p id="total-vouchers-count">०</p></div>
                </div>
                <h4>पछिल्ला भौचरहरू</h4>
                <div class="table-container">
                    <table id="recent-vouchers-table">
                        <thead><tr><th>भौचर नं.</th><th>मिति</th><th>जम्मा रकम (रु.)</th><th>कार्य</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
            
            <section id="voucher-list-section" class="content-section">
                <h3>भौचर सूची</h3>
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" id="voucher-search-input" placeholder="भौचर नं. वा विवरणबाट खोज्नुहोस्...">
                    </div>
                </div>
                <div class="table-container">
                    <table id="all-vouchers-table">
                         <thead><tr><th>भौचर नं.</th><th>मिति</th><th>विवरण</th><th>जम्मा रकम (रु.)</th><th>कार्य</th></tr></thead>
                         <tbody></tbody>
                    </table>
                </div>
            </section>

            <section id="voucher-section" class="content-section">
                <h3 id="voucher-form-title">नयाँ गोश्वार भौचर</h3>
                <form id="voucher-form">
                    <input type="hidden" id="editing-voucher-id">
                    <div class="form-row">
                        <div class="form-group"><label for="voucher-no">भौचर नं.</label><input type="text" id="voucher-no" required></div>
                        <div class="form-group"><label for="voucher-date">मिति (YYYYMMDD)</label><input type="text" id="voucher-date" placeholder="जस्तै: २०८१०२०३" required></div>
                    </div>
                    <div class="form-group"><label for="voucher-narration">संक्षिप्त विवरण (Narration)</label><input type="text" id="voucher-narration" placeholder="जस्तै: तलब भुक्तानी सम्बन्धमा" required></div>
                    <div class="table-container">
                        <table id="voucher-entry-table">
                            <thead><tr><th>विवरण (खाता)</th><th>डेबिट (रु.)</th><th>क्रेडिट (रु.)</th><th><button type="button" id="add-voucher-row-btn">+</button></th></tr></thead>
                            <tbody id="voucher-entry-body"></tbody>
                        </table>
                    </div>
                    <div class="voucher-totals">
                        <div>जम्मा डेबिट: <span id="total-debit">०/-</span></div>
                        <div>जम्मा क्रेडिट: <span id="total-credit">०/-</span></div>
                    </div>
                    <div class="form-buttons">
                        <button type="submit" id="save-voucher-btn" class="submit-btn">भौचर सुरक्षित गर्नुहोस्</button>
                        <button type="button" id="cancel-edit-btn" class="cancel-btn" style="display: none;">रद्द गर्नुहोस्</button>
                    </div>
                </form>
            </section>

            <section id="accounts-section" class="content-section">
                <h3>खाताका शीर्षकहरू व्यवस्थापन गर्नुहोस्</h3>
                <form id="add-account-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="account-nature">खाताको प्रकृति</label>
                            <select id="account-nature" required>
                                <option value="">-- छान्नुहोस् --</option>
                                <option value="आम्दानी">आम्दानी (Income)</option>
                                <option value="खर्च">खर्च (Expense)</option>
                                <option value="सम्पत्ति">सम्पत्ति (Asset)</option>
                                <option value="दायित्व">दायित्व (Liability)</option>
                                <option value="व्यक्तिगत">व्यक्तिगत (Personal)</option>
                            </select>
                        </div>
                        <div class="form-group" id="source-type-group">
                            <label for="source-type">स्रोतको प्रकार</label>
                            <select id="source-type" required>
                                <option value="">-- छान्नुहोस् --</option>
                                <option value="सरकारी">सरकारी (Governmental)</option>
                                <option value="आन्तरिक">आन्तरिक (Internal)</option>
                                <option value="लागू नहुने">लागू नहुने (N/A)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="standard-name-group">
                        <label for="account-name">खाताको नाम</label>
                        <input type="text" id="account-name" placeholder="जस्तै: तलब, कुमारी बैंक, सन्त बहादुर" required>
                    </div>
                     <div class="form-group hidden" id="gov-expense-group">
                        <label for="gov-expense-topic-select">खर्चको शीर्षक (सरकारी आम्दानी अनुसार)</label>
                        <select id="gov-expense-topic-select" required></select>
                    </div>
                    <button type="submit" class="submit-btn">खाता थप्नुहोस्</button>
                </form>
                <hr>
                <h4>विद्यमान खाताहरू</h4>
                <div class="table-container"><table id="accounts-table"><thead><tr><th>पूर्ण नाम</th><th>प्रकृति</th><th>स्रोत</th><th>कार्य</th></tr></thead><tbody></tbody></table></div>
            </section>
            
            <section id="assets-section" class="content-section">
                <div id="asset-view">
                    <div class="report-header">
                        <h3>स्थिर सम्पत्ति रजिस्टर</h3>
                        <div>
                             <button id="add-new-asset-btn" class="submit-btn">नयाँ सम्पत्ति थप्नुहोस्</button>
                             <button id="print-asset-register-btn" class="print-btn">प्रिन्ट गर्नुहोस्</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="assets-table">
                            <thead>
                                <tr>
                                    <th>नाम</th>
                                    <th>प्रकार</th>
                                    <th>खरिद मिति</th>
                                    <th class="text-right">सुरुवाती लागत (रु.)</th>
                                    <th class="text-right">थप लागत (रु.)</th>
                                    <th class="text-right">जम्मा लागत (रु.)</th>
                                    <th class="text-center">ह्रा. दर</th>
                                    <th class="text-right">वार्षिक ह्रासकट्टी (रु.)</th>
                                    <th class="text-right">खुद बाँकी रकम (रु.)</th>
                                    <th>कार्य</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </div>
                <div id="asset-form-view" class="hidden">
                     <h3 id="asset-form-title">नयाँ सम्पत्ति</h3>
                     <form id="add-asset-form">
                         <input type="hidden" id="editing-asset-id">
                         <div class="form-row">
                             <div class="form-group">
                                 <label for="asset-name">सम्पत्तिको नाम</label>
                                 <input type="text" id="asset-name" required>
                             </div>
                             <div class="form-group">
                                <label for="asset-type">सम्पत्तिको प्रकार</label>
                                <select id="asset-type" required>
                                    <option value="">-- छान्नुहोस् --</option>
                                    <option value="जग्गा">जग्गा</option>
                                    <option value="भवन">भवन</option>
                                    <option value="फर्निचर">फर्निचर</option>
                                    <option value="अफिस सामग्री">अफिस सामग्री</option>
                                    <option value="मेसिनरी तथा अन्य">मेसिनरी तथा अन्य</option>
                                </select>
                            </div>
                         </div>
                         <div class="form-row">
                             <div class="form-group">
                                 <label for="asset-purchase-date">खरिद/स्थापना मिति</label>
                                 <input type="text" id="asset-purchase-date" placeholder="जस्तै: २०८१०४०१" required>
                             </div>
                             <div class="form-group">
                                 <label for="asset-depreciation-rate">ह्रासकट्टी दर (%)</label>
                                 <input type="number" id="asset-depreciation-rate" value="0" step="0.01" required>
                             </div>
                         </div>
                         <div class="form-row">
                              <div class="form-group">
                                 <label for="asset-opening-cost">सुरुवाती लागत (रु.)</label>
                                 <input type="number" id="asset-opening-cost" value="0" step="0.01" required>
                             </div>
                             <div class="form-group">
                                 <label for="asset-added-cost">यस वर्ष थपिएको लागत (रु.)</label>
                                 <input type="number" id="asset-added-cost" value="0" step="0.01" required>
                             </div>
                         </div>
                         <div class="form-buttons">
                            <button type="submit" class="submit-btn">सुरक्षित गर्नुहोस्</button>
                            <button type="button" id="cancel-asset-edit-btn" class="cancel-btn">रद्द गर्नुहोस्</button>
                         </div>
                     </form>
                </div>
            </section>

            <section id="ledger-section" class="content-section">
                <h3>खाताको लेजर हेर्नुहोस्</h3>
                <div class="form-group"><label for="ledger-account-select">खाता छान्नुहोस्</label><select id="ledger-account-select"></select></div>
                <div id="ledger-report">
                    <div class="ledger-header"><h4 id="ledger-account-title"></h4><button id="print-ledger-btn" class="print-btn" style="display: none;">प्रिन्ट गर्नुहोस्</button></div>
                    <div class="table-container"><table id="ledger-table"><thead><tr><th>मिति</th><th>विवरण</th><th>भौ.नं.</th><th>डेबिट (रु.)</th><th>क्रेडिट (रु.)</th><th>बाँकी (रु.)</th><th>डे./क्रे.</th></tr></thead><tbody></tbody></table></div>
                </div>
            </section>

            <section id="trial-balance-section" class="content-section">
                <div class="report-header"><h3>सन्तुलन परीक्षण</h3><button id="print-trial-balance-btn" class="print-btn">प्रिन्ट गर्नुहोस्</button></div>
                <div class="table-container"><table id="trial-balance-table"><thead><tr><th>खाताको नाम</th><th>डेबिट (रु.)</th><th>क्रेडिट (रु.)</th></tr></thead><tbody></tbody><tfoot></tfoot></table></div>
            </section>

            <section id="reconciliation-section" class="content-section">
                 <div class="report-header">
                     <h3>बैंक हिसाब मिलान विवरण</h3>
                     <button id="print-recon-btn" class="print-btn">प्रिन्ट गर्नुहोस्</button>
                 </div>
                 <div class="form-row">
                    <div class="form-group">
                        <label for="recon-bank-select">बैंक खाता छान्नुहोस्</label>
                        <select id="recon-bank-select"></select>
                    </div>
                     <div class="form-group">
                        <label for="recon-date">... सम्मको मिति</label>
                        <input type="text" id="recon-date" placeholder="जस्तै: २०८१०४०१">
                    </div>
                 </div>
                 <p>आफ्नो बैंक स्टेटमेन्टसँग तलको विवरण भिडाउनुहोस् र मिलान भएका कारोबारहरूमा टिक लगाउनुहोस्।</p>
                 <div class="recon-container">
                     <div>
                         <h4>लेजर अनुसारको कारोबार</h4>
                         <div class="table-container">
                             <table id="recon-ledger-table" class="recon-table">
                                 <thead><tr><th><input type="checkbox" id="check-all-ledger"></th><th>मिति</th><th>विवरण</th><th class="text-right">डेबिट (रु.)</th><th class="text-right">क्रेडिट (रु.)</th></tr></thead>
                                 <tbody></tbody>
                             </table>
                         </div>
                         <div class="recon-totals">लेजर अनुसार बाँकी: <span id="ledger-balance">रु. ०/-</span></div>
                     </div>
                     <div>
                         <h4>बैंक स्टेटमेन्ट अनुसारको कारोबार</h4>
                          <form id="add-statement-entry-form" class="form-row" style="align-items: flex-end; margin-bottom: 15px; background-color: #f9f9f9; padding: 10px; border-radius: 5px;">
                            <div class="form-group" style="flex: 1.5;">
                                <label for="statement-date">मिति</label>
                                <input type="text" id="statement-date" placeholder="२०८१०४०१" required>
                            </div>
                            <div class="form-group" style="flex: 3;">
                                <label for="statement-description">विवरण</label>
                                <input type="text" id="statement-description" required>
                            </div>
                            <div class="form-group" style="flex: 1.5;">
                                <label for="statement-amount">रकम</label>
                                <input type="number" id="statement-amount" step="0.01" required>
                            </div>
                            <div class="form-group" style="flex: 1.5;">
                                <label for="statement-type">प्रकार</label>
                                <select id="statement-type">
                                    <option value="debit">निकालेको (Debit)</option>
                                    <option value="credit">जम्मा (Credit)</option>
                                </select>
                            </div>
                            <button type="submit" class="submit-btn" style="padding: 10px 15px; height: 44px;">थप्नुहोस्</button>
                        </form>
                          <div class="table-container">
                             <table id="recon-statement-table" class="recon-table">
                                 <thead><tr><th><input type="checkbox" id="check-all-statement"></th><th>मिति</th><th>विवरण</th><th class="text-right">डेबिट (रु.)</th><th class="text-right">क्रेडिट (रु.)</th><th></th></tr></thead>
                                 <tbody></tbody>
                             </table>
                         </div>
                          <div class="recon-totals">स्टेटमेन्ट अनुसार बाँकी: <span id="statement-balance">रु. ०/-</span></div>
                     </div>
                 </div>
            </section>
            
            <section id="reports-section" class="content-section">
                <div class="report-header">
                    <h3>आम्दानी-खर्च विवरण</h3>
                    <button id="print-statement-btn" class="print-btn">प्रिन्ट गर्नुहोस्</button>
                </div>
                <div id="income-expense-statement">
                    <div id="income-side">
                         <h4>आम्दानीहरू (Incomes)</h4>
                         <div class="table-container"><table id="income-table" class="report-table"><tbody></tbody></table></div>
                    </div>
                    <div id="expense-side">
                         <h4>खर्चहरू (Expenses)</h4>
                         <div class="table-container"><table id="expense-table" class="report-table"><tbody></tbody></table></div>
                    </div>
                </div>
                <div class="table-container">
                    <table class="report-table">
                        <tbody><tr class="net-balance-row"><td id="net-balance-label"></td><td id="net-balance-amount" class="text-right"></td></tr></tbody>
                    </table>
                </div>
            </section>

            <section id="settings-section" class="content-section">
                <h3>प्रणाली सेटिङ्ग</h3>
                <div class="setting-box">
                    <h4>नयाँ आर्थिक वर्ष सिर्जना गर्नुहोस्</h4>
                    <form id="new-fy-form">
                        <div class="form-group">
                            <label for="new-fy-name">नयाँ आर्थिक वर्ष (जस्तै: २०८१/८२)</label>
                            <input type="text" id="new-fy-name" placeholder="२०८१/८२">
                        </div>
                        <button type="button" id="create-fy-btn" class="submit-btn">सिर्जना गर्नुहोस्</button>
                    </form>
                </div>

                <div class="setting-box">
                     <h4>विद्यमान आर्थिक वर्षहरू</h4>
                     <div class="table-container">
                        <table id="fy-management-table">
                            <thead>
                                <tr>
                                    <th>आर्थिक वर्ष</th>
                                    <th>अवस्था</th>
                                    <th style="width: 250px;">कार्यहरू</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                     </div>
                </div>

                <div class="setting-box">
                    <h4>भौचर मेटाउनुहोस् (Delete Voucher)</h4>
                     <p><b>सावधानी:</b> यो कार्य अपरिवर्तनीय हो। एक पटक मेटाइएको भौचर फिर्ता ल्याउन सकिँदैन।</p>
                    <form id="delete-voucher-form">
                         <div class="form-group">
                            <label for="voucher-no-to-delete">मेटाउन चाहेको भौचर नं.</label>
                            <input type="text" id="voucher-no-to-delete" placeholder="भौचर नं. लेख्नुहोस्" required>
                        </div>
                        <button type="button" id="delete-voucher-btn" class="delete-btn" style="background-color: var(--danger-color); color: white; padding: 12px 20px;">भौचर मेटाउनुहोस्</button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <div id="print-area"></div>
    
    <!-- Modals will be created dynamically by JS -->

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, setDoc, getDocs, getDoc, writeBatch, query, where, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Configuration and Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyDZ1_bVyAVhExJ1N62hOGQqWp9ORcpRBTw",
            authDomain: "surya-account.firebaseapp.com",
            projectId: "surya-account",
            storageBucket: "surya-account.firebasestorage.app",
            messagingSenderId: "19051227285",
            appId: "1:19051227285:web:aec46bde47b0759f48539c"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);

        // --- Global State and DOM Elements ---
        let state = { accounts: [], vouchers: [], assets: [], fiscalYears: [], activeFyId: null };
        let accountsUnsubscribe = null;
        let vouchersUnsubscribe = null;
        let assetsUnsubscribe = null;
        const dom = {
            appLoader: document.getElementById('app-loader'), loaderMessage: document.getElementById('loader-message'),
            loginContainer: document.getElementById('login-container'), mainContainer: document.querySelector('.container'),
            loginForm: document.getElementById('login-form'), signupForm: document.getElementById('signup-form'),
            loginView: document.getElementById('login-view'), signupView: document.getElementById('signup-view'),
            showSignup: document.getElementById('show-signup'), showLogin: document.getElementById('show-login'),
            logoutBtn: document.getElementById('logout-btn'), activeFyDisplay: document.getElementById('active-fy-display'),
            navButtons: document.querySelectorAll('.nav-btn'), contentSections: document.querySelectorAll('.content-section'),
            addAccountForm: document.getElementById('add-account-form'), accountNatureSelect: document.getElementById('account-nature'),
            sourceTypeGroup: document.getElementById('source-type-group'),
            sourceTypeSelect: document.getElementById('source-type'), standardNameGroup: document.getElementById('standard-name-group'),
            accountNameInput: document.getElementById('account-name'), govExpenseGroup: document.getElementById('gov-expense-group'),
            govExpenseTopicSelect: document.getElementById('gov-expense-topic-select'), accountsTableBody: document.querySelector('#accounts-table tbody'),
            voucherForm: document.getElementById('voucher-form'), voucherFormTitle: document.getElementById('voucher-form-title'),
            voucherNoInput: document.getElementById('voucher-no'), voucherDateInput: document.getElementById('voucher-date'),
            voucherNarrationInput: document.getElementById('voucher-narration'), voucherEntryBody: document.getElementById('voucher-entry-body'),
            addVoucherRowBtn: document.getElementById('add-voucher-row-btn'), totalDebitSpan: document.getElementById('total-debit'),
            totalCreditSpan: document.getElementById('total-credit'), editingVoucherIdInput: document.getElementById('editing-voucher-id'),
            saveVoucherBtn: document.getElementById('save-voucher-btn'), cancelEditBtn: document.getElementById('cancel-edit-btn'),
            ledgerAccountSelect: document.getElementById('ledger-account-select'), ledgerTableBody: document.querySelector('#ledger-table tbody'),
            ledgerAccountTitle: document.getElementById('ledger-account-title'), printLedgerBtn: document.getElementById('print-ledger-btn'),
            trialBalanceTableBody: document.querySelector('#trial-balance-table tbody'), trialBalanceTableFoot: document.querySelector('#trial-balance-table tfoot'),
            printTrialBalanceBtn: document.getElementById('print-trial-balance-btn'), printArea: document.getElementById('print-area'),
            totalAccountsCount: document.getElementById('total-accounts-count'), totalVouchersCount: document.getElementById('total-vouchers-count'),
            recentVouchersTableBody: document.querySelector('#recent-vouchers-table tbody'),
            allVouchersTableBody: document.querySelector('#all-vouchers-table tbody'),
            voucherSearchInput: document.getElementById('voucher-search-input'),
            incomeTableBody: document.querySelector('#income-table tbody'), expenseTableBody: document.querySelector('#expense-table tbody'),
            netBalanceLabel: document.getElementById('net-balance-label'), netBalanceAmount: document.getElementById('net-balance-amount'),
            printStatementBtn: document.getElementById('print-statement-btn'),
            fyManagementTableBody: document.querySelector('#fy-management-table tbody'),
            newFyNameInput: document.getElementById('new-fy-name'), createFyBtn: document.getElementById('create-fy-btn'),
            deleteVoucherForm: document.getElementById('delete-voucher-form'), voucherNoToDeleteInput: document.getElementById('voucher-no-to-delete'),
            deleteVoucherBtn: document.getElementById('delete-voucher-btn'),
            // New Asset Elements
            assetView: document.getElementById('asset-view'), assetFormView: document.getElementById('asset-form-view'),
            addNewAssetBtn: document.getElementById('add-new-asset-btn'),
            addAssetForm: document.getElementById('add-asset-form'), assetFormTitle: document.getElementById('asset-form-title'),
            editingAssetIdInput: document.getElementById('editing-asset-id'), assetsTableBody: document.querySelector('#assets-table tbody'),
            assetsTableFoot: document.querySelector('#assets-table tfoot'),
            cancelAssetEditBtn: document.getElementById('cancel-asset-edit-btn'),
            printAssetRegisterBtn: document.getElementById('print-asset-register-btn'),
            // New Reconciliation Elements
            reconBankSelect: document.getElementById('recon-bank-select'),
            reconDateInput: document.getElementById('recon-date'),
            reconLedgerTableBody: document.querySelector('#recon-ledger-table tbody'),
            reconStatementTableBody: document.querySelector('#recon-statement-table tbody'),
            addStatementEntryForm: document.getElementById('add-statement-entry-form'),
        };

        // --- Modal and Utility Functions ---
        const showModal = (message, type = 'info') => {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            const modalBox = document.createElement('div');
            modalBox.className = `modal-box ${type}`;
            modalBox.textContent = message;
            modalOverlay.appendChild(modalBox);
            document.body.appendChild(modalOverlay);
            setTimeout(() => modalOverlay.classList.add('visible'), 10);
            setTimeout(() => {
                modalOverlay.classList.remove('visible');
                setTimeout(() => document.body.removeChild(modalOverlay), 300);
            }, 2500);
        };
        const showConfirmModal = (message) => {
             return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay visible';
                modal.innerHTML = `
                    <div class="modal-box">
                        <h3>निश्चित गर्नुहोस्</h3>
                        <p>${message}</p>
                        <div>
                            <button type="button" class="cancel-btn">होइन</button>
                            <button type="button" class="submit-btn">हो</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
                modal.querySelector('.submit-btn').onclick = () => { document.body.removeChild(modal); resolve(true); };
                modal.querySelector('.cancel-btn').onclick = () => { document.body.removeChild(modal); resolve(false); };
            });
        };
        const showPasswordModal = (title = 'पासवर्ड प्रमाणित गर्नुहोस्', text = 'यो कार्य पूरा गर्न कृपया आफ्नो लगइन पासवर्ड हाल्नुहोस्।') => {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay visible';
                modal.innerHTML = `
                    <div class="modal-box">
                        <h3>${title}</h3>
                        <p>${text}</p>
                        <form id="password-prompt-form">
                            <div class="form-group" style="text-align: left;">
                                <label for="prompt-password">पासवर्ड</label>
                                <input type="password" id="prompt-password" required>
                            </div>
                            <div>
                                <button type="button" class="cancel-btn">रद्द गर्नुहोस्</button>
                                <button type="submit" class="submit-btn">प्रमाणित गर्नुहोस्</button>
                            </div>
                        </form>
                    </div>`;
                document.body.appendChild(modal);
                const form = modal.querySelector('form');
                const cancelBtn = modal.querySelector('.cancel-btn');
                const passwordInput = modal.querySelector('#prompt-password');
                const close = () => document.body.removeChild(modal);
                cancelBtn.onclick = () => { close(); resolve(null); };
                form.onsubmit = (e) => { e.preventDefault(); const pass = passwordInput.value; close(); resolve(pass); };
                passwordInput.focus();
            });
        };
        const showPromptModal = (title, label, placeholder) => {
            return new Promise((resolve) => {
                 const modal = document.createElement('div');
                modal.className = 'modal-overlay visible';
                modal.innerHTML = `
                    <div class="modal-box">
                        <h3>${title}</h3>
                        <form id="prompt-form">
                            <div class="form-group" style="text-align: left;">
                                <label for="prompt-input">${label}</label>
                                <input type="text" id="prompt-input" value="${placeholder}" required>
                            </div>
                            <div>
                                <button type="button" class="cancel-btn">रद्द गर्नुहोस्</button>
                                <button type="submit" class="submit-btn">सुरक्षित गर्नुहोस्</button>
                            </div>
                        </form>
                    </div>`;
                document.body.appendChild(modal);
                const form = modal.querySelector('form');
                const cancelBtn = modal.querySelector('.cancel-btn');
                form.onsubmit = (e) => { e.preventDefault(); const val = form.querySelector('input').value; document.body.removeChild(modal); resolve(val); };
                cancelBtn.onclick = () => { document.body.removeChild(modal); resolve(null); };
                form.querySelector('input').focus();
            });
        };
        const nepaliDigits = ['०', '१', '२', '३', '४', '५', '६', '७', '८', '९'];
        const toEnglish = (numStr) => String(numStr).split('').map(c => nepaliDigits.indexOf(c) !== -1 ? nepaliDigits.indexOf(c) : c).join('');
        const toDevanagari = (numStr) => String(numStr).replace(/[0-9]/g, d => nepaliDigits[d]);
        const formatVoucherAmount = (num) => {
            if (num === null || num === undefined || isNaN(num)) num = 0;
            const isNegative = num < 0;
            const fixedNum = Math.abs(num).toFixed(2);
            const [integerPart, decimalPart] = fixedNum.split('.');
            let formattedInteger = integerPart.slice(-3);
            const otherNumbers = integerPart.slice(0, -3);
            if(otherNumbers) formattedInteger = otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + ',' + formattedInteger;
            const nepaliInteger = toDevanagari(formattedInteger);
            let nepaliAmount;
            if (!decimalPart || parseInt(decimalPart, 10) === 0) {
                nepaliAmount = `${nepaliInteger}/-`;
            } else {
                nepaliAmount = `${nepaliInteger}/${toDevanagari(decimalPart)}`;
            }
            return isNegative ? `(${nepaliAmount})` : nepaliAmount;
        };
        const formatNepaliDate = (dateString) => {
            if (!dateString || !dateString.includes('-')) return '';
            const [year, month, day] = dateString.split('-');
            return `${toDevanagari(year)}/${toDevanagari(month)}/${toDevanagari(day)}`;
        };
        const formatDateInput = (e) => {
            let value = e.target.value.replace(/[^\d०१२३४५६७८९]/g, '');
            let engValue = toEnglish(value);
            if (engValue.length >= 8) {
                engValue = engValue.slice(0, 8);
                e.target.dataset.rawValue = `${engValue.substring(0, 4)}-${engValue.substring(4, 6)}-${engValue.substring(6, 8)}`;
                e.target.value = `${toDevanagari(engValue.substring(0, 4))}-${toDevanagari(engValue.substring(4, 6))}-${toDevanagari(engValue.substring(6, 8))}`;
            } else { e.target.dataset.rawValue = ''; }
        };
        const handleVoucherNoInput = (e) => {
            const devanagariValue = e.target.value.replace(/[^\d०१२३४५६७८९]/g, '');
            e.target.dataset.rawValue = toEnglish(devanagariValue);
            e.target.value = devanagariValue;
        };

        // --- Authentication and Initialization ---
        onAuthStateChanged(auth, async user => {
            if (user) {
                dom.loginContainer.classList.add('hidden');
                dom.mainContainer.classList.remove('hidden');
                dom.appLoader.classList.remove('hidden');
                dom.loaderMessage.textContent = 'आर्थिक वर्ष लोड हुँदैछ...';
                await loadFiscalYearSettings(user.uid);
            } else {
                dom.loginContainer.classList.remove('hidden'); dom.mainContainer.classList.add('hidden');
                dom.appLoader.classList.add('hidden');
                if (accountsUnsubscribe) accountsUnsubscribe();
                if (vouchersUnsubscribe) vouchersUnsubscribe();
                if (assetsUnsubscribe) assetsUnsubscribe();
            }
        });
        
        async function loadFiscalYearSettings(uid) {
            try {
                const settingsRef = doc(db, `users/${uid}/settings`, 'fiscalYears');
                const settingsSnap = await getDoc(settingsRef);
                if (settingsSnap.exists()) {
                    const settings = settingsSnap.data();
                    state.fiscalYears = settings.years || [];
                    state.activeFyId = settings.activeId || null;
                } else { state.fiscalYears = []; state.activeFyId = null; }

                if (state.fiscalYears.length === 0) {
                    dom.loaderMessage.textContent = 'कुनै आर्थिक वर्ष भेटिएन। कृपया एउटा सिर्जना गर्नुहोस्।';
                    document.getElementById('nav-settings').click();
                    dom.appLoader.classList.add('hidden');
                } else {
                    if (!state.activeFyId || !state.fiscalYears.find(fy => fy.id === state.activeFyId)) {
                         state.activeFyId = state.fiscalYears[0].id;
                    }
                    await setupFirestoreListeners(uid, state.activeFyId);
                }
                updateFyUi();
            } catch(e) { console.error(e); dom.loaderMessage.textContent = 'आ.व. लोड गर्न असफल भयो।'; }
        }

        function updateFyUi() {
            if (state.activeFyId) {
                const activeFy = state.fiscalYears.find(fy => fy.id === state.activeFyId);
                dom.activeFyDisplay.textContent = activeFy ? `आ.व.: ${toDevanagari(activeFy.name)}` : 'आ.व. छान्नुहोस्';
            }
            renderFyManagementTable();
        }

        async function setupFirestoreListeners(uid, fyId) {
            dom.loaderMessage.textContent = 'डाटा लोड हुँदैछ...';
            if (accountsUnsubscribe) accountsUnsubscribe();
            if (vouchersUnsubscribe) vouchersUnsubscribe();
            if (assetsUnsubscribe) assetsUnsubscribe();
            
            const accountsRef = collection(db, `users/${uid}/fiscalYears/${fyId}/accounts`);
            const vouchersRef = collection(db, `users/${uid}/fiscalYears/${fyId}/vouchers`);
            const assetsRef = collection(db, `users/${uid}/fiscalYears/${fyId}/assets`);

            let loadingCounter = 3;
            const onDataLoaded = () => {
                loadingCounter--;
                if (loadingCounter === 0) {
                    renderAll();
                    dom.appLoader.classList.add('hidden');
                }
            };

            accountsUnsubscribe = onSnapshot(query(accountsRef), (snapshot) => {
                state.accounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                onDataLoaded();
            }, (err) => { console.error(err); onDataLoaded(); });

            vouchersUnsubscribe = onSnapshot(query(vouchersRef), (snapshot) => {
                state.vouchers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                onDataLoaded();
            }, (err) => { console.error(err); onDataLoaded(); });
            
            assetsUnsubscribe = onSnapshot(query(assetsRef), (snapshot) => {
                state.assets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                onDataLoaded();
            }, (err) => { console.error(err); onDataLoaded(); });
        }
        
        // --- Render Functions ---
        const renderAll = () => {
            if (!auth.currentUser || !state.activeFyId) return;
            const activeSectionId = document.querySelector('.content-section.active')?.id;

            renderDashboard();
            if (activeSectionId === 'voucher-list-section') renderVoucherList();
            if (activeSectionId === 'accounts-section') { renderAccounts(); populateGovExpenseTopics(); }
            if (activeSectionId === 'assets-section') renderAssets();
            if (activeSectionId === 'ledger-section') { renderLedgerSelect(); if(dom.ledgerAccountSelect.value) renderLedger(); }
            if (activeSectionId === 'trial-balance-section') renderTrialBalance();
            if (activeSectionId === 'reconciliation-section') { renderReconciliationSelect(); renderReconciliation(); }
            if (activeSectionId === 'reports-section') renderIncomeExpenseStatement();
        };

        const renderDashboard = () => {
            dom.totalAccountsCount.textContent = toDevanagari(state.accounts.length.toString());
            dom.totalVouchersCount.textContent = toDevanagari(state.vouchers.length.toString());
            dom.recentVouchersTableBody.innerHTML = '';
            const recentVouchers = [...state.vouchers].sort((a, b) => b.voucherNo - a.voucherNo).slice(0, 5);
            if (recentVouchers.length === 0) {
                dom.recentVouchersTableBody.innerHTML = '<tr><td colspan="4" class="text-center">कुनै भौचर भेटिएन।</td></tr>';
                return;
            }
            recentVouchers.forEach(voucher => {
                const total = voucher.entries.reduce((sum, entry) => sum + (entry.debit || 0), 0);
                dom.recentVouchersTableBody.innerHTML += `<tr><td>${toDevanagari(voucher.voucherNo.toString())}</td><td>${formatNepaliDate(voucher.date)}</td><td class="text-right">${formatVoucherAmount(total)}</td><td><button class="print-voucher-btn" data-voucher-id="${voucher.id}">प्रिन्ट</button><button class="edit-btn" data-voucher-id="${voucher.id}">एडिट</button></td></tr>`;
            });
        };
        const renderVoucherList = () => {
            const searchTerm = toEnglish(dom.voucherSearchInput.value.toLowerCase());
            const filteredVouchers = state.vouchers
                .filter(v => v.voucherNo.toString().includes(searchTerm) || v.narration.toLowerCase().includes(searchTerm))
                .sort((a, b) => b.voucherNo - a.voucherNo);

            dom.allVouchersTableBody.innerHTML = '';
            if (filteredVouchers.length === 0) {
                 dom.allVouchersTableBody.innerHTML = '<tr><td colspan="5" class="text-center">कुनै भौचर भेटिएन।</td></tr>';
                 return;
            }
            filteredVouchers.forEach(voucher => {
                const total = voucher.entries.reduce((sum, entry) => sum + (entry.debit || 0), 0);
                 dom.allVouchersTableBody.innerHTML += `<tr><td>${toDevanagari(voucher.voucherNo.toString())}</td><td>${formatNepaliDate(voucher.date)}</td><td>${voucher.narration}</td><td class="text-right">${formatVoucherAmount(total)}</td><td><button class="print-voucher-btn" data-voucher-id="${voucher.id}">प्रिन्ट</button><button class="edit-btn" data-voucher-id="${voucher.id}">एडिट</button></td></tr>`;
            });
        };
        const renderAccounts = () => {
            dom.accountsTableBody.innerHTML = '';
            if (state.accounts.length === 0) {
                dom.accountsTableBody.innerHTML = '<tr><td colspan="4" class="text-center">कुनै खाता थपिएको छैन।</td></tr>'; return;
            }
            const sortedAccounts = [...state.accounts].sort((a, b) => a.fullName.localeCompare(b.fullName, 'ne'));
            sortedAccounts.forEach(account => {
                dom.accountsTableBody.innerHTML += `<tr><td>${account.fullName}</td><td>${account.nature}</td><td>${account.sourceType}</td><td><button class="delete-btn" data-id="${account.id}">हटाउनुहोस्</button></td></tr>`;
            });
        };

        const renderAssets = () => {
            dom.assetsTableBody.innerHTML = '';
            dom.assetsTableFoot.innerHTML = '';
            let totalOpening = 0, totalAdded = 0, totalCost = 0, totalDepreciation = 0, totalNet = 0;

            const sortedAssets = [...state.assets].sort((a, b) => a.name.localeCompare(b.name, 'ne'));

            sortedAssets.forEach(asset => {
                const openingCost = parseFloat(asset.openingCost) || 0;
                const addedCost = parseFloat(asset.addedCost) || 0;
                const depreciationRate = parseFloat(asset.depreciationRate) || 0;

                const currentTotalCost = openingCost + addedCost;
                const annualDepreciation = currentTotalCost * (depreciationRate / 100);
                const netValue = currentTotalCost - annualDepreciation;
                
                totalOpening += openingCost;
                totalAdded += addedCost;
                totalCost += currentTotalCost;
                totalDepreciation += annualDepreciation;
                totalNet += netValue;

                dom.assetsTableBody.innerHTML += `
                    <tr>
                        <td>${asset.name}</td>
                        <td>${asset.type}</td>
                        <td>${formatNepaliDate(asset.purchaseDate)}</td>
                        <td class="text-right">${formatVoucherAmount(openingCost)}</td>
                        <td class="text-right">${formatVoucherAmount(addedCost)}</td>
                        <td class="text-right">${formatVoucherAmount(currentTotalCost)}</td>
                        <td class="text-center">${toDevanagari(depreciationRate)}%</td>
                        <td class="text-right">${formatVoucherAmount(annualDepreciation)}</td>
                        <td class="text-right">${formatVoucherAmount(netValue)}</td>
                        <td>
                            <button class="edit-btn" data-id="${asset.id}">एडिट</button>
                            <button class="delete-btn" data-id="${asset.id}">डिलिट</button>
                        </td>
                    </tr>`;
            });

            dom.assetsTableFoot.innerHTML = `
                <tr>
                    <td colspan="3"><b>जम्मा</b></td>
                    <td class="text-right"><b>${formatVoucherAmount(totalOpening)}</b></td>
                    <td class="text-right"><b>${formatVoucherAmount(totalAdded)}</b></td>
                    <td class="text-right"><b>${formatVoucherAmount(totalCost)}</b></td>
                    <td colspan="1"></td>
                    <td class="text-right"><b>${formatVoucherAmount(totalDepreciation)}</b></td>
                    <td class="text-right"><b>${formatVoucherAmount(totalNet)}</b></td>
                    <td></td>
                </tr>`;
        };
        
        const getAccountOptions = (selectedId = null) => {
            const sortedAccounts = [...state.accounts].sort((a, b) => a.fullName.localeCompare(b.fullName, 'ne'));
            return sortedAccounts.map(acc => `<option value="${acc.id}" ${selectedId === acc.id ? 'selected' : ''}>${acc.fullName}</option>`).join('');
        };
        const addVoucherRow = (entry = {}) => {
            const row = document.createElement('tr');
            row.innerHTML = `<td><select class="voucher-account-select" required><option value="">-- खाता छान्नुहोस् --</option>${getAccountOptions(entry.accountId)}</select></td><td><input type="number" class="voucher-debit" value="${entry.debit || ''}" placeholder="०.००" step="0.01"></td><td><input type="number" class="voucher-credit" value="${entry.credit || ''}" placeholder="०.००" step="0.01"></td><td><button type="button" class="delete-row-btn">-</button></td>`;
            dom.voucherEntryBody.appendChild(row);
        };
        const renderVoucherRows = (count = 2) => {
            dom.voucherEntryBody.innerHTML = '';
            for (let i = 0; i < count; i++) { addVoucherRow(); }
            updateVoucherTotals();
        };
        const updateVoucherTotals = () => {
            let totalDebit = 0, totalCredit = 0;
            dom.voucherEntryBody.querySelectorAll('tr').forEach(row => {
                totalDebit += parseFloat(row.querySelector('.voucher-debit').value) || 0;
                totalCredit += parseFloat(row.querySelector('.voucher-credit').value) || 0;
            });
            dom.totalDebitSpan.textContent = formatVoucherAmount(totalDebit);
            dom.totalCreditSpan.textContent = formatVoucherAmount(totalCredit);
        };
        const renderLedgerSelect = () => { dom.ledgerAccountSelect.innerHTML = ['<option value="">-- खाता छान्नुहोस् --</option>', getAccountOptions()].join(''); };
        const renderLedger = () => {
            const accountId = dom.ledgerAccountSelect.value;
            dom.ledgerTableBody.innerHTML = '';
            dom.printLedgerBtn.style.display = 'none';
            if (!accountId) { dom.ledgerAccountTitle.textContent = ''; return; }
            const account = state.accounts.find(a => a.id === accountId);
            if (!account) return;
            dom.ledgerAccountTitle.textContent = `${account.fullName} को लेजर`;
            dom.printLedgerBtn.style.display = 'inline-block';
            const relevantEntries = [];
            state.vouchers.forEach(voucher => {
                const mainEntry = voucher.entries.find(e => e.accountId === accountId);
                if (!mainEntry) return;
                const isDebitEntry = (mainEntry.debit || 0) > 0;
                const opposingAccountNames = voucher.entries
                    .filter(e => isDebitEntry ? (e.credit || 0) > 0 : (e.debit || 0) > 0)
                    .map(e => state.accounts.find(a => a.id === e.accountId)?.fullName).filter(Boolean).join(', ');
                relevantEntries.push({ ...mainEntry, date: voucher.date, voucherNo: voucher.voucherNo, description: opposingAccountNames || voucher.narration });
            });
            if (relevantEntries.length === 0) { dom.ledgerTableBody.innerHTML = '<tr><td colspan="7" class="text-center">कुनै कारोबार छैन।</td></tr>'; return; }
            relevantEntries.sort((a, b) => new Date(a.date) - new Date(b.date) || a.voucherNo - b.voucherNo);
            let balance = 0, tableHTML = '';
            relevantEntries.forEach(entry => {
                balance += (entry.debit || 0) - (entry.credit || 0);
                tableHTML += `<tr><td>${formatNepaliDate(entry.date)}</td><td>${entry.description}</td><td class="text-center">${toDevanagari(entry.voucherNo.toString())}</td><td class="text-right">${formatVoucherAmount(entry.debit)}</td><td class="text-right">${formatVoucherAmount(entry.credit)}</td><td class="text-right">${formatVoucherAmount(Math.abs(balance))}</td><td class="text-center">${balance >= 0 ? 'डे.' : 'क्रे.'}</td></tr>`;
            });
            dom.ledgerTableBody.innerHTML = tableHTML;
        };
        const renderTrialBalance = () => {
            dom.trialBalanceTableBody.innerHTML = '';
            dom.trialBalanceTableFoot.innerHTML = '';
            let totalDebit = 0;
            let totalCredit = 0;
            const balances = {};

            state.accounts.forEach(account => {
                balances[account.id] = { balance: 0, account };
            });

            state.vouchers.forEach(voucher => {
                voucher.entries.forEach(entry => {
                    if (balances[entry.accountId]) {
                        balances[entry.accountId].balance += (entry.debit || 0) - (entry.credit || 0);
                    }
                });
            });
            
            Object.values(balances).forEach(({ balance, account }) => {
                if (Math.abs(balance) < 0.001) return;

                let isDebit = balance > 0;
                let isCredit = balance < 0;

                if (account.nature === 'व्यक्तिगत') {
                    // Handled above by balance sign
                } else if (['आम्दानी', 'दायित्व'].includes(account.nature)) {
                    // Normal balance is credit. If balance is negative, it becomes debit.
                    isCredit = balance < 0;
                    isDebit = balance > 0;
                    balance = -balance; // Invert for display
                }

                dom.trialBalanceTableBody.innerHTML += `<tr>
                    <td>${account.fullName}</td>
                    <td class="text-right">${isDebit ? formatVoucherAmount(balance) : '—'}</td>
                    <td class="text-right">${isCredit ? formatVoucherAmount(Math.abs(balance)) : '—'}</td>
                </tr>`;

                if (isDebit) totalDebit += balance;
                if (isCredit) totalCredit += Math.abs(balance);
            });

            dom.trialBalanceTableFoot.innerHTML = `<tr><td><b>जम्मा</b></td><td class="text-right"><b>${formatVoucherAmount(totalDebit)}</b></td><td class="text-right"><b>${formatVoucherAmount(totalCredit)}</b></td></tr>`;
            if (Math.abs(totalDebit - totalCredit) > 0.01) {
                dom.trialBalanceTableFoot.querySelector('tr').style.cssText = 'background-color: var(--danger-color); color: white;';
            }
        };

        const renderReconciliationSelect = () => {
            const bankAccounts = state.accounts.filter(acc => acc.nature === 'सम्पत्ति' && acc.fullName.toLowerCase().includes('bank') || acc.fullName.includes('बैंक'));
            const currentSelection = dom.reconBankSelect.value;
            dom.reconBankSelect.innerHTML = '<option value="">-- बैंक खाता छान्नुहोस् --</option>' + 
                bankAccounts.map(acc => `<option value="${acc.id}">${acc.fullName}</option>`).join('');
            dom.reconBankSelect.value = currentSelection;
        };

        const renderReconciliation = () => {
            const bankAccountId = dom.reconBankSelect.value;
            const reconDate = dom.reconDateInput.dataset.rawValue;
            
            dom.reconLedgerTableBody.innerHTML = '';
            dom.reconStatementTableBody.innerHTML = '';

            if(!bankAccountId || !reconDate) return;

            // Render Ledger Transactions
            const ledgerEntries = [];
            state.vouchers.forEach(v => {
                if (v.date > reconDate) return;
                v.entries.forEach(e => {
                    if (e.accountId === bankAccountId) {
                        ledgerEntries.push({
                            date: v.date,
                            description: v.narration,
                            debit: e.debit || 0,
                            credit: e.credit || 0,
                        });
                    }
                });
            });
            
            ledgerEntries.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(entry => {
                dom.reconLedgerTableBody.innerHTML += `
                    <tr>
                        <td><input type="checkbox"></td>
                        <td>${formatNepaliDate(entry.date)}</td>
                        <td>${entry.description}</td>
                        <td class="text-right">${entry.debit > 0 ? formatVoucherAmount(entry.debit) : '-'}</td>
                        <td class="text-right">${entry.credit > 0 ? formatVoucherAmount(entry.credit) : '-'}</td>
                    </tr>
                `;
            });

            // Render Statement Transactions
            if (!state.statementEntries) state.statementEntries = [];
            state.statementEntries.forEach(entry => {
                 dom.reconStatementTableBody.innerHTML += `
                    <tr>
                        <td><input type="checkbox"></td>
                        <td>${formatNepaliDate(entry.date)}</td>
                        <td>${entry.description}</td>
                        <td class="text-right">${entry.type === 'debit' ? formatVoucherAmount(entry.amount) : '-'}</td>
                        <td class="text-right">${entry.type === 'credit' ? formatVoucherAmount(entry.amount) : '-'}</td>
                        <td><button class="delete-btn statement-delete-btn" data-id="${entry.id}" style="padding: 2px 5px; font-size: 0.8em;">X</button></td>
                    </tr>
                `;
            });
        };
        
        const startEditVoucher = (voucherId) => { 
            const voucher = state.vouchers.find(v => v.id === voucherId);
            if (!voucher) return;
            resetVoucherForm();
            dom.editingVoucherIdInput.value = voucher.id;
            dom.voucherFormTitle.textContent = `भौचर नं. ${toDevanagari(voucher.voucherNo.toString())} सम्पादन गर्दै`;
            dom.voucherNoInput.value = toDevanagari(voucher.voucherNo.toString());
            dom.voucherNoInput.dataset.rawValue = voucher.voucherNo;
            dom.voucherDateInput.value = formatNepaliDate(voucher.date).replace(/\//g, '-');
            dom.voucherDateInput.dataset.rawValue = voucher.date;
            dom.voucherNarrationInput.value = voucher.narration;
            dom.voucherEntryBody.innerHTML = '';
            voucher.entries.forEach(entry => addVoucherRow(entry));
            updateVoucherTotals();
            dom.saveVoucherBtn.textContent = 'अपडेट गर्नुहोस्';
            dom.cancelEditBtn.style.display = 'inline-block';
            document.getElementById('nav-voucher').click();
        };
        const resetVoucherForm = () => { 
             dom.voucherForm.reset();
            dom.editingVoucherIdInput.value = '';
            dom.voucherNoInput.dataset.rawValue = '';
            dom.voucherDateInput.dataset.rawValue = '';
            dom.voucherFormTitle.textContent = 'नयाँ गोश्वार भौचर';
            dom.saveVoucherBtn.textContent = 'भौचर सुरक्षित गर्नुहोस्';
            dom.cancelEditBtn.style.display = 'none';
            renderVoucherRows(2);
         };
         
        // --- Core Logic (Events, Firebase interactions) ---
        async function reauthenticate(password) {
            try {
                const user = auth.currentUser;
                const credential = EmailAuthProvider.credential(user.email, password);
                await reauthenticateWithCredential(user, credential);
                return true;
            } catch (error) {
                console.error("Reauthentication failed:", error);
                showModal('पासवर्ड मिलेन। कृपया पुन: प्रयास गर्नुहोस्।', 'error');
                return false;
            }
        }
        
        dom.createFyBtn.addEventListener('click', async () => {
            let fyName = dom.newFyNameInput.value.trim();
            fyName = toEnglish(fyName).replace(/[^0-9/]/g, ''); // Sanitize and convert
            if(!fyName.match(/^\d{4}\/\d{2}$/)) { showModal('कृपया "२०८१/८२" जस्तो सही ढाँचामा आ.व. लेख्नुहोस्।', 'error'); return; }
            if(state.fiscalYears.some(fy => fy.name === fyName)) { showModal('यो आर्थिक वर्ष पहिले नै सिर्जना भइसकेको छ।', 'error'); return; }
            const confirmed = await showConfirmModal(`के तपाईं नयाँ आर्थिक वर्ष "${toDevanagari(fyName)}" सिर्जना गर्न चाहनुहुन्छ?`);
            if(!confirmed) return;
            const newFyId = Date.now().toString();
            const newFyList = [...state.fiscalYears, {id: newFyId, name: fyName}];
            const settingsRef = doc(db, `users/${auth.currentUser.uid}/settings`, 'fiscalYears');
            await setDoc(settingsRef, { years: newFyList, activeId: state.activeFyId || newFyId }, { merge: true });
            dom.newFyNameInput.value = '';
            showModal(`आर्थिक वर्ष "${toDevanagari(fyName)}" सफलतापूर्वक सिर्जना भयो!`, 'success');
            await loadFiscalYearSettings(auth.currentUser.uid);
        });
        
        const renderFyManagementTable = () => {
            dom.fyManagementTableBody.innerHTML = '';
            state.fiscalYears.forEach(fy => {
                const isActive = fy.id === state.activeFyId;
                dom.fyManagementTableBody.innerHTML += `
                    <tr>
                        <td>${toDevanagari(fy.name)}</td>
                        <td>${isActive ? '<b>सक्रिय</b>' : 'निष्क्रिय'}</td>
                        <td>
                            <button class="action-btn-activate" data-id="${fy.id}" ${isActive ? 'disabled' : ''}>सक्रिय बनाउनुहोस्</button>
                            <button class="action-btn-edit" data-id="${fy.id}" data-name="${fy.name}">एडिट</button>
                            <button class="action-btn-delete" data-id="${fy.id}">डिलिट</button>
                        </td>
                    </tr>`;
            });
        };

        const handleFyManagementClick = async (e) => {
            const target = e.target;
            const id = target.dataset.id;
            if (!id) return;

            if (target.classList.contains('action-btn-activate')) {
                const password = await showPasswordModal('आ.व. परिवर्तन गर्नुहोस्', `तपाईं "${toDevanagari(state.fiscalYears.find(f=>f.id===id).name)}" लाई सक्रिय बनाउँदै हुनुहुन्छ। कृपया पासवर्ड हाल्नुहोस्।`);
                if(!password) return;
                if(await reauthenticate(password)) {
                    const settingsRef = doc(db, `users/${auth.currentUser.uid}/settings`, 'fiscalYears');
                    await setDoc(settingsRef, { activeId: id }, { merge: true });
                    showModal('आर्थिक वर्ष सफलतापूर्वक परिवर्तन भयो! प्रणाली पुनः लोड हुँदैछ...', 'success');
                    dom.appLoader.classList.remove('hidden');
                    await loadFiscalYearSettings(auth.currentUser.uid);
                }
            } else if (target.classList.contains('action-btn-edit')) {
                const oldName = target.dataset.name;
                let newName = await showPromptModal('आर्थिक वर्ष एडिट गर्नुहोस्', 'नयाँ नाम', toDevanagari(oldName));
                if (!newName) return;
                newName = toEnglish(newName).replace(/[^0-9/]/g, '');
                if(!newName.match(/^\d{4}\/\d{2}$/)) { showModal('अमान्य ढाँचा। कृपया "२०८१/८२" जस्तो लेख्नुहोस्।', 'error'); return; }
                if (state.fiscalYears.some(fy => fy.name === newName && fy.id !== id)) { showModal('यो नाम पहिले नै प्रयोग भइसकेको छ।', 'error'); return; }
                
                const password = await showPasswordModal();
                if (!password) return;
                if (await reauthenticate(password)) {
                    const updatedFyList = state.fiscalYears.map(fy => fy.id === id ? { ...fy, name: newName } : fy);
                    const settingsRef = doc(db, `users/${auth.currentUser.uid}/settings`, 'fiscalYears');
                    await setDoc(settingsRef, { years: updatedFyList }, { merge: true });
                    showModal('आर्थिक वर्ष सफलतापूर्वक एडिट भयो!', 'success');
                    await loadFiscalYearSettings(auth.currentUser.uid);
                }
            } else if (target.classList.contains('action-btn-delete')) {
                const voucherCheckRef = collection(db, `users/${auth.currentUser.uid}/fiscalYears/${id}/vouchers`);
                const q = query(voucherCheckRef, limit(1));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) { showModal('यो आ.व. मा भौचरहरू भएकोले मेटाउन मिल्दैन।', 'error'); return; }

                const confirmed = await showConfirmModal('के तपाईं यो आर्थिक वर्ष स्थायी रूपमा मेटाउन चाहनुहुन्छ?');
                if (!confirmed) return;
                
                const password = await showPasswordModal();
                if (!password) return;

                if (await reauthenticate(password)) {
                    const updatedFyList = state.fiscalYears.filter(fy => fy.id !== id);
                    let newActiveId = state.activeFyId;
                    if (state.activeFyId === id) { // If deleting the active one
                        newActiveId = updatedFyList.length > 0 ? updatedFyList[0].id : null;
                    }
                    const settingsRef = doc(db, `users/${auth.currentUser.uid}/settings`, 'fiscalYears');
                    await setDoc(settingsRef, { years: updatedFyList, activeId: newActiveId }, { merge: true });
                    showModal('आर्थिक वर्ष सफलतापूर्वक मेटाइयो!', 'success');
                    dom.appLoader.classList.remove('hidden');
                    await loadFiscalYearSettings(auth.currentUser.uid);
                }
            }
        };
        dom.fyManagementTableBody.addEventListener('click', handleFyManagementClick);

        dom.deleteVoucherBtn.addEventListener('click', async () => {
            const voucherNoStr = dom.voucherNoToDeleteInput.value.trim();
            const voucherNo = parseInt(toEnglish(voucherNoStr));
            if(isNaN(voucherNo)) { showModal('कृपया सही भौचर नं. लेख्नुहोस्।', 'error'); return; }
            const voucherQuery = query(collection(db, `users/${auth.currentUser.uid}/fiscalYears/${state.activeFyId}/vouchers`), where("voucherNo", "==", voucherNo));
            const querySnapshot = await getDocs(voucherQuery);
            if(querySnapshot.empty) { showModal(`भौचर नं. ${toDevanagari(voucherNo.toString())} भेटिएन।`, 'error'); return; }
            const voucherDoc = querySnapshot.docs[0];
            const confirmed = await showConfirmModal(`के तपाईं साँच्चै भौचर नं. ${toDevanagari(voucherNo.toString())} लाई स्थायी रूपमा मेटाउन चाहनुहुन्छ?`);
            if(!confirmed) return;
            const password = await showPasswordModal();
            if(!password) return;
            if(await reauthenticate(password)) {
                await deleteDoc(voucherDoc.ref);
                showModal(`भौचर नं. ${toDevanagari(voucherNo.toString())} सफलतापूर्वक मेटाइयो!`, 'success');
                dom.deleteVoucherForm.reset();
            }
        });
        
        const renderIncomeExpenseStatement = () => {
             const { accountTotals, incomeGroups, expenseGroups } = calculateIncomeExpenses();
             let totalIncome = 0, totalExpense = 0;

             const createTableRows = (groups) => {
                let html = '';
                Object.keys(groups).sort((a,b) => a.localeCompare(b,'ne')).forEach(sourceType => {
                    html += `<tr><td colspan="2" class="sub-header">${sourceType}</td></tr>`;
                    let subTotal = 0;
                    groups[sourceType].sort((a,b) => a.name.localeCompare(b.name, 'ne')).forEach(acc => {
                        const amount = (acc.nature === 'आम्दानी' ? accountTotals[acc.id].credit : accountTotals[acc.id].debit);
                        if (amount > 0) {
                           html += `<tr><td>${acc.name}</td><td class="text-right">${formatVoucherAmount(amount)}</td></tr>`;
                           subTotal += amount;
                        }
                    });
                    html += `<tr><td><b>जम्मा ${sourceType}</b></td><td class="text-right"><b>${formatVoucherAmount(subTotal)}</b></td></tr>`;
                });
                return html;
             };
             
             dom.incomeTableBody.innerHTML = createTableRows(incomeGroups);
             dom.expenseTableBody.innerHTML = createTableRows(expenseGroups);
             
             Object.values(incomeGroups).flat().forEach(acc => totalIncome += accountTotals[acc.id]?.credit || 0);
             Object.values(expenseGroups).flat().forEach(acc => totalExpense += accountTotals[acc.id]?.debit || 0);
             
             const netBalance = totalIncome - totalExpense;
             dom.netBalanceLabel.textContent = 'कुल जम्मा आम्दानी: ' + formatVoucherAmount(totalIncome) + ' | कुल जम्मा खर्च: ' + formatVoucherAmount(totalExpense) + ' | खुद बचत / घाटा';
             dom.netBalanceAmount.textContent = formatVoucherAmount(netBalance);
        };
        
        const calculateIncomeExpenses = () => {
            const accountTotals = state.accounts.reduce((acc, account) => ({...acc, [account.id]: { debit: 0, credit: 0 }}), {});
            state.vouchers.forEach(voucher => {
                voucher.entries.forEach(entry => {
                    if (accountTotals[entry.accountId]) {
                        accountTotals[entry.accountId].debit += entry.debit || 0;
                        accountTotals[entry.accountId].credit += entry.credit || 0;
                    }
                });
            });

            const incomeGroups = {}, expenseGroups = {};
            state.accounts.forEach(acc => {
                const group = acc.nature === 'आम्दानी' ? incomeGroups : (acc.nature === 'खर्च' ? expenseGroups : null);
                if (group) {
                    const sourceKey = acc.sourceType === 'लागू नहुने' ? 'विविध' : acc.sourceType;
                    if (!group[sourceKey]) group[sourceKey] = [];
                    group[sourceKey].push(acc);
                }
            });
            return { accountTotals, incomeGroups, expenseGroups };
        };

        const handleAccountFormChange = () => {
            const nature = dom.accountNatureSelect.value;
            const source = dom.sourceTypeSelect.value;
            
            if (nature === 'व्यक्तिगत') {
                dom.sourceTypeGroup.classList.add('hidden');
                dom.sourceTypeSelect.required = false;
            } else {
                dom.sourceTypeGroup.classList.remove('hidden');
                dom.sourceTypeSelect.required = true;
            }

            if (nature === 'खर्च' && source === 'सरकारी') {
                dom.standardNameGroup.classList.add('hidden'); dom.accountNameInput.required = false;
                dom.govExpenseGroup.classList.remove('hidden'); dom.govExpenseTopicSelect.required = true;
            } else {
                dom.standardNameGroup.classList.remove('hidden'); dom.accountNameInput.required = true;
                dom.govExpenseGroup.classList.add('hidden'); dom.govExpenseTopicSelect.required = false;
            }
        };

        const populateGovExpenseTopics = () => {
            const govIncomeAccounts = state.accounts.filter(a => a.nature === 'आम्दानी' && a.sourceType === 'सरकारी');
            const uniqueNames = [...new Set(govIncomeAccounts.map(a => a.name))];
            if (uniqueNames.length > 0) {
                dom.govExpenseTopicSelect.innerHTML = '<option value="">-- शीर्षक छान्नुहोस् --</option>' + uniqueNames.map(name => `<option value="${name}">${name}</option>`).join('');
            } else { dom.govExpenseTopicSelect.innerHTML = '<option value="">-- पहिले सरकारी आम्दानी खाता बनाउनुहोस् --</option>'; }
        };

        const handleNavClick = (e) => {
            if (!e.target.classList.contains('nav-btn')) return;
            dom.navButtons.forEach(btn => btn.classList.remove('active')); e.target.classList.add('active');
            const targetSectionId = e.target.id.replace('nav-', '') + '-section';
            dom.contentSections.forEach(sec => sec.classList.remove('active'));
            document.getElementById(targetSectionId).classList.add('active');
            
            if (e.target.id === 'nav-voucher' && !dom.editingVoucherIdInput.value) resetVoucherForm();
            else renderAll();
        };

        const handleSaveVoucher = async (e) => {
            e.preventDefault();
            const editingId = dom.editingVoucherIdInput.value;
            const voucherNo = parseInt(dom.voucherNoInput.dataset.rawValue); const date = dom.voucherDateInput.dataset.rawValue;
            const narration = dom.voucherNarrationInput.value.trim();
            if (isNaN(voucherNo) || !date || !narration) { showModal('कृपया सही भौचर नं., मिति, र विवरण भर्नुहोस्।', 'error'); return; }
            if (!editingId && state.vouchers.some(v => v.voucherNo === voucherNo)) { showModal('यो भौचर नं. पहिले नै प्रयोग भइसकेको छ।', 'error'); return; }
            let totalDebit = 0, totalCredit = 0; const entries = [];
            dom.voucherEntryBody.querySelectorAll('tr').forEach(row => {
                const accountId = row.querySelector('.voucher-account-select').value;
                const debit = parseFloat(row.querySelector('.voucher-debit').value) || 0;
                const credit = parseFloat(row.querySelector('.voucher-credit').value) || 0;
                if (accountId && (debit > 0 || credit > 0)) { entries.push({ accountId, debit, credit }); totalDebit += debit; totalCredit += credit; }
            });
            if (entries.length < 2) { showModal('भौचरमा कम्तिमा दुईवटा कारोबार हुनुपर्छ।', 'error'); return; }
            if (Math.abs(totalDebit - totalCredit) > 0.001 || totalDebit === 0) { showModal('डेबिट र क्रेडिट रकम बराबर हुनुपर्छ।', 'error'); return; }
            const newVoucher = { voucherNo, date, narration, entries };
            const collectionRef = collection(db, `users/${auth.currentUser.uid}/fiscalYears/${state.activeFyId}/vouchers`);
            const docRef = editingId ? doc(collectionRef, editingId) : doc(collectionRef);
            await setDoc(docRef, newVoucher);
            showModal(editingId ? 'भौचर सफलतापूर्वक अपडेट भयो!' : 'भौचर सफलतापूर्वक सुरक्षित भयो!', 'success');
            resetVoucherForm();
        };

        const handleAddAccount = async (e) => {
            e.preventDefault();
            const nature = dom.accountNatureSelect.value; 
            let sourceType = dom.sourceTypeSelect.value;
            if (nature === 'व्यक्तिगत') sourceType = 'लागू नहुने';

            let name = (nature === 'खर्च' && sourceType === 'सरकारी') ? dom.govExpenseTopicSelect.value : dom.accountNameInput.value.trim();
            
            if (!nature || !sourceType || !name) { showModal('कृपया सबै विवरणहरू भर्नुहोस्।', 'error'); return; }
            const fullName = (nature === 'व्यक्तिगत' || sourceType === 'लागू नहुने') ? `${nature} - ${name}` : `${nature} (${sourceType}) - ${name}`;
            if (state.accounts.some(acc => acc.fullName.toLowerCase() === fullName.toLowerCase())) { showModal('यो खाता पहिले नै अवस्थित छ।', 'error'); return; }
            const newAccount = { nature, sourceType, name, fullName };
            await addDoc(collection(db, `users/${auth.currentUser.uid}/fiscalYears/${state.activeFyId}/accounts`), newAccount);
            showModal('खाता सफलतापूर्वक थपियो!', 'success');
            dom.addAccountForm.reset(); handleAccountFormChange();
        };

        const handleDeleteAccount = async (e) => {
            if (!e.target.classList.contains('delete-btn')) return;
            const accountId = e.target.dataset.id;
            if (!accountId) return;
            const isUsed = state.vouchers.some(v => v.entries.some(en => en.accountId === accountId));
            if (isUsed) { showModal('यो खाता भौचरमा प्रयोग भइसकेकोले हटाउन मिल्दैन।', 'error'); return; }
            const confirmed = await showConfirmModal('के तपाईं यो खाता साँच्चै हटाउन चाहनुहुन्छ?');
            if (!confirmed) return;
            await deleteDoc(doc(db, `users/${auth.currentUser.uid}/fiscalYears/${state.activeFyId}/accounts`, accountId));
            showModal('खाता सफलतापूर्वक हटाइयो!', 'success');
        };

        const handleAddStatementEntry = (e) => {
            e.preventDefault();
            const date = document.getElementById('statement-date').dataset.rawValue;
            const description = document.getElementById('statement-description').value;
            const amount = parseFloat(document.getElementById('statement-amount').value);
            const type = document.getElementById('statement-type').value;

            if (!date || !description || isNaN(amount) || amount <= 0) {
                showModal('कृपया मिति, विवरण र सही रकम भर्नुहोस्।', 'error');
                return;
            }

            if (!state.statementEntries) state.statementEntries = [];
            state.statementEntries.push({ id: Date.now(), date, description, amount, type });
            
            renderReconciliation();
            dom.addStatementEntryForm.reset();
            document.getElementById('statement-date').dataset.rawValue = '';
        };

        const handleDeleteStatementEntry = (e) => {
            if (!e.target.classList.contains('statement-delete-btn')) return;
            const entryId = parseInt(e.target.dataset.id);
            state.statementEntries = state.statementEntries.filter(entry => entry.id !== entryId);
            renderReconciliation();
        };

        const handleSaveAsset = async (e) => {
            e.preventDefault();
            const editingId = dom.editingAssetIdInput.value;
            const assetData = {
                name: document.getElementById('asset-name').value,
                type: document.getElementById('asset-type').value,
                purchaseDate: document.getElementById('asset-purchase-date').dataset.rawValue,
                openingCost: parseFloat(document.getElementById('asset-opening-cost').value) || 0,
                addedCost: parseFloat(document.getElementById('asset-added-cost').value) || 0,
                depreciationRate: parseFloat(document.getElementById('asset-depreciation-rate').value) || 0,
            };

            if (!assetData.name || !assetData.type || !assetData.purchaseDate) {
                showModal('कृपया सबै विवरणहरू भर्नुहोस्।', 'error');
                return;
            }
            
            const collectionRef = collection(db, `users/${auth.currentUser.uid}/fiscalYears/${state.activeFyId}/assets`);
            if (editingId) {
                await setDoc(doc(collectionRef, editingId), assetData);
                showModal('सम्पत्ति सफलतापूर्वक अपडेट भयो!', 'success');
            } else {
                await addDoc(collectionRef, assetData);
                showModal('सम्पत्ति सफलतापूर्वक थपियो!', 'success');
            }
            
            resetAssetForm();
        };

        const resetAssetForm = () => {
            dom.addAssetForm.reset();
            dom.editingAssetIdInput.value = '';
            dom.assetFormTitle.textContent = 'नयाँ सम्पत्ति';
            dom.assetView.classList.remove('hidden');
            dom.assetFormView.classList.add('hidden');
        };

        const startEditAsset = (assetId) => {
            const asset = state.assets.find(a => a.id === assetId);
            if (!asset) return;

            resetAssetForm();
            dom.assetView.classList.add('hidden');
            dom.assetFormView.classList.remove('hidden');

            dom.assetFormTitle.textContent = `सम्पत्ति "${asset.name}" सम्पादन गर्दै`;
            dom.editingAssetIdInput.value = asset.id;
            document.getElementById('asset-name').value = asset.name;
            document.getElementById('asset-type').value = asset.type;
            
            const dateInput = document.getElementById('asset-purchase-date');
            dateInput.dataset.rawValue = asset.purchaseDate;
            const [year, month, day] = asset.purchaseDate.split('-');
            dateInput.value = `${toDevanagari(year)}-${toDevanagari(month)}-${toDevanagari(day)}`;
            
            document.getElementById('asset-opening-cost').value = asset.openingCost;
            document.getElementById('asset-added-cost').value = asset.addedCost;
            document.getElementById('asset-depreciation-rate').value = asset.depreciationRate;
        };

        const handleDeleteAsset = async (assetId) => {
            if (!assetId) return;
            const confirmed = await showConfirmModal('के तपाईं यो सम्पत्ति साँच्चै हटाउन चाहनुहुन्छ?');
            if (!confirmed) return;
            await deleteDoc(doc(db, `users/${auth.currentUser.uid}/fiscalYears/${state.activeFyId}/assets`, assetId));
            showModal('सम्पत्ति सफलतापूर्वक हटाइयो!', 'success');
        };
        

        const printStatement = () => {
            const activeFy = state.fiscalYears.find(fy => fy.id === state.activeFyId);
            const reportTitle = `आम्दानी-खर्च विवरण (आ.व. ${toDevanagari(activeFy.name)})`;
            const statementContent = document.getElementById('income-expense-statement').innerHTML;
            const netBalanceContent = document.querySelector('.net-balance-row').parentElement.parentElement.outerHTML;
            const headerHTML = `<div class="print-header"><h1>सूर्य ज्योति माध्यमिक विद्यालय मेहेलकुना</h1><p>गुर्भाकोट नगरपालिका-८, सुर्खेत</p><h2>${reportTitle}</h2></div>`;
            dom.printArea.innerHTML = headerHTML + '<div id="income-expense-statement">' + statementContent + '</div>' + netBalanceContent;
            window.print();
        };
        
        const printGenericReport = (tableId, reportTitle) => {
            const tableContent = document.getElementById(tableId)?.outerHTML;
            if (!tableContent) return;
            const activeFy = state.fiscalYears.find(fy => fy.id === state.activeFyId);
            const fullReportTitle = `${reportTitle} (आ.व. ${toDevanagari(activeFy.name)})`;
            const headerHTML = `<div class="print-header"><h1>सूर्य ज्योति माध्यमिक विद्यालय मेहेलकुना</h1><p>गुर्भाकोट नगरपालिका-८, सुर्खेत</p><h2>${fullReportTitle}</h2></div>`;
            dom.printArea.innerHTML = headerHTML + tableContent;
            window.print();
        };
        
        const printVoucher = (voucherId) => {
            const voucher = state.vouchers.find(v => v.id === voucherId);
            if (!voucher) return;
            let entriesHTML = '', total = 0;
            voucher.entries.forEach(entry => {
                const account = state.accounts.find(a => a.id === entry.accountId);
                if(!account) return;
                const isDebit = entry.debit > 0;
                total += entry.debit || 0;
                entriesHTML += `<tr><td class="text-center">${isDebit ? 'डे.' : 'क्रे.'}</td><td>${account.fullName}</td><td class="text-right">${isDebit ? formatVoucherAmount(entry.debit) : '—'}</td><td class="text-right">${!isDebit ? formatVoucherAmount(entry.credit) : '—'}</td></tr>`;
            });
            const activeFy = state.fiscalYears.find(fy => fy.id === state.activeFyId);
            const voucherHTML = `
                <div class="print-header">
                    <h1>सूर्य ज्योति माध्यमिक विद्यालय मेहेलकुना</h1>
                    <p>गुर्भाकोट नगरपालिका-८, सुर्खेत</p>
                    <h2>गोश्वार भौचर (आ.व. ${toDevanagari(activeFy.name)})</h2>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12pt;"><span><b>गो. भौचर नं.:</b> ${toDevanagari(voucher.voucherNo.toString())}</span><span><b>मिति:</b> ${formatNepaliDate(voucher.date)}</span></div>
                <table border="1"><thead><tr><th style="width:5%">संकेत</th><th>विवरण</th><th style="width:20%">डेबिट (रु.)</th><th style="width:20%">क्रेडिट (रु.)</th></tr></thead>
                <tbody>${entriesHTML}<tr style="font-style: italic;"><td colspan="4">(${voucher.narration})</td></tr></tbody>
                <tfoot><tr><td colspan="2" class="text-right"><b>जम्मा</b></td><td class="text-right"><b>${formatVoucherAmount(total)}</b></td><td class="text-right"><b>${formatVoucherAmount(total)}</b></td></tr></tfoot></table>
                <div style="margin-top: 60px; display: flex; justify-content: space-between; font-size: 11pt; page-break-inside: avoid;"><div style="width: 200px; text-align: center;"><p style="margin: 40px 0 5px 0; border-top: 1px solid #000; padding-top: 5px;">तयार गर्ने</p><span>दर्जा: लेखापाल</span></div><div style="width: 200px; text-align: center;"><p style="margin: 40px 0 5px 0; border-top: 1px solid #000; padding-top: 5px;">सदर गर्ने</p><span>दर्जा: प्र.अ.</span></div></div>`;
            dom.printArea.innerHTML = voucherHTML;
            window.print();
        };

        // EVENT LISTENERS
        dom.signupForm.addEventListener('submit', (e) => { e.preventDefault(); const email = dom.signupForm['signup-email'].value; const password = dom.signupForm['signup-password'].value; createUserWithEmailAndPassword(auth, email, password).then(() => showModal('खाता सफलतापूर्वक सिर्जना भयो!', 'success')).catch((err) => showModal(err.message, 'error')); });
        dom.loginForm.addEventListener('submit', (e) => { e.preventDefault(); const email = dom.loginForm['login-email'].value; const password = dom.loginForm['login-password'].value; signInWithEmailAndPassword(auth, email, password).catch(() => showModal('इमेल वा पासवर्ड मिलेन।', 'error')); });
        dom.logoutBtn.addEventListener('click', () => signOut(auth));
        dom.showSignup.addEventListener('click', () => { dom.loginView.classList.add('hidden'); dom.signupView.classList.remove('hidden'); });
        dom.showLogin.addEventListener('click', () => { dom.signupView.classList.add('hidden'); dom.loginView.classList.remove('hidden'); });
        dom.navButtons.forEach(btn => btn.addEventListener('click', handleNavClick));
        dom.voucherForm.addEventListener('submit', handleSaveVoucher);
        dom.addAccountForm.addEventListener('submit', handleAddAccount);
        dom.accountsTableBody.addEventListener('click', handleDeleteAccount);
        dom.cancelEditBtn.addEventListener('click', resetVoucherForm);
        dom.voucherNoInput.addEventListener('input', handleVoucherNoInput);
        dom.voucherDateInput.addEventListener('input', formatDateInput);
        dom.addVoucherRowBtn.addEventListener('click', () => addVoucherRow());
        dom.voucherEntryBody.addEventListener('input', updateVoucherTotals);
        dom.voucherEntryBody.addEventListener('click', (e) => { if (e.target.classList.contains('delete-row-btn')) { if (dom.voucherEntryBody.rows.length > 2) e.target.closest('tr').remove(); else showModal('भौचरमा कम्तिमा दुई पङ्क्ति हुनुपर्छ।', 'error'); updateVoucherTotals(); } });
        dom.ledgerAccountSelect.addEventListener('change', renderLedger);
        dom.printLedgerBtn.addEventListener('click', () => printGenericReport('ledger-table', dom.ledgerAccountTitle.textContent));
        dom.printTrialBalanceBtn.addEventListener('click', () => printGenericReport('trial-balance-table', 'सन्तुलन परीक्षण'));
        const handleTableActions = (e) => { if (e.target.classList.contains('print-voucher-btn')) printVoucher(e.target.dataset.voucherId); if (e.target.classList.contains('edit-btn')) startEditVoucher(e.target.dataset.voucherId); };
        dom.recentVouchersTableBody.addEventListener('click', handleTableActions);
        dom.allVouchersTableBody.addEventListener('click', handleTableActions);
        dom.voucherSearchInput.addEventListener('input', renderVoucherList);
        dom.accountNatureSelect.addEventListener('change', handleAccountFormChange);
        dom.sourceTypeSelect.addEventListener('change', handleAccountFormChange);
        dom.printStatementBtn.addEventListener('click', printStatement);

        // New Asset Event Listeners
        dom.addAssetForm.addEventListener('submit', handleSaveAsset);
        document.getElementById('asset-purchase-date').addEventListener('input', formatDateInput);
        dom.addNewAssetBtn.addEventListener('click', () => {
             resetAssetForm();
             dom.assetView.classList.add('hidden');
             dom.assetFormView.classList.remove('hidden');
        });
        dom.cancelAssetEditBtn.addEventListener('click', resetAssetForm);
        dom.assetsTableBody.addEventListener('click', (e) => {
            const assetId = e.target.dataset.id;
            if (e.target.classList.contains('edit-btn')) {
                startEditAsset(assetId);
            } else if (e.target.classList.contains('delete-btn')) {
                handleDeleteAsset(assetId);
            }
        });
        dom.printAssetRegisterBtn.addEventListener('click', () => printGenericReport('assets-table', 'स्थिर सम्पत्ति रजिस्टर'));

        // New Reconciliation Event Listeners
        dom.reconBankSelect.addEventListener('change', () => {
            state.statementEntries = []; // Clear previous entries when bank changes
            renderReconciliation();
        });
        dom.reconDateInput.addEventListener('input', formatDateInput);
        dom.reconDateInput.addEventListener('change', renderReconciliation);
        dom.addStatementEntryForm.addEventListener('submit', handleAddStatementEntry);
        document.getElementById('statement-date').addEventListener('input', formatDateInput);
        dom.reconStatementTableBody.addEventListener('click', handleDeleteStatementEntry);


    </script>
</body>
</html>

